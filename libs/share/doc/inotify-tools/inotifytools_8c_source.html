<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libinotifytools: inotifytools.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>inotifytools.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// kate: replace-tabs off; space-indent off;</span>
<a name="l00002"></a>00002 
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;../../config.h&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="inotifytools_8h.html" title="inotifytools library public interface.">inotifytools/inotifytools.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;inotifytools_p.h&quot;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;strings.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;sys/select.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;regex.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;setjmp.h&gt;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;inotifytools/inotify.h&quot;</span>
<a name="l00035"></a>00035 
<a name="l00122"></a>00122 <span class="preprocessor">#define MAX_EVENTS 4096</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span><span class="preprocessor">#define MAX_STRLEN 4096</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span><span class="preprocessor">#define INOTIFY_PROCDIR &quot;/proc/sys/fs/inotify/&quot;</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span><span class="preprocessor">#define WATCHES_SIZE_PATH INOTIFY_PROCDIR &quot;max_user_watches&quot;</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span><span class="preprocessor">#define QUEUE_SIZE_PATH   INOTIFY_PROCDIR &quot;max_queued_events&quot;</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span><span class="preprocessor">#define INSTANCES_PATH    INOTIFY_PROCDIR &quot;max_user_instances&quot;</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>
<a name="l00129"></a>00129 <span class="keyword">static</span> <span class="keywordtype">int</span> inotify_fd;
<a name="l00130"></a>00130 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_access;
<a name="l00131"></a>00131 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_modify;
<a name="l00132"></a>00132 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_attrib;
<a name="l00133"></a>00133 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_close_nowrite;
<a name="l00134"></a>00134 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_close_write;
<a name="l00135"></a>00135 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_open;
<a name="l00136"></a>00136 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_move_self;
<a name="l00137"></a>00137 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_moved_to;
<a name="l00138"></a>00138 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_moved_from;
<a name="l00139"></a>00139 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_create;
<a name="l00140"></a>00140 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_delete;
<a name="l00141"></a>00141 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_delete_self;
<a name="l00142"></a>00142 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_unmount;
<a name="l00143"></a>00143 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>  num_total;
<a name="l00144"></a>00144 <span class="keyword">static</span> <span class="keywordtype">int</span> collect_stats = 0;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="keyword">struct </span>rbtree *tree_wd = 0;
<a name="l00147"></a>00147 <span class="keyword">struct </span>rbtree *tree_filename = 0;
<a name="l00148"></a>00148 <span class="keyword">static</span> <span class="keywordtype">int</span> error = 0;
<a name="l00149"></a>00149 <span class="keyword">static</span> <span class="keywordtype">int</span> init = 0;
<a name="l00150"></a>00150 <span class="keyword">static</span> <span class="keywordtype">char</span>* timefmt = 0;
<a name="l00151"></a>00151 <span class="keyword">static</span> regex_t* regex = 0;
<a name="l00152"></a>00152 <span class="comment">/* 0: --exclude[i], 1: --include[i] */</span>
<a name="l00153"></a>00153 <span class="keyword">static</span> <span class="keywordtype">int</span> invert_regexp = 0;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 <span class="keyword">static</span> <span class="keywordtype">int</span> isdir( <span class="keywordtype">char</span> <span class="keyword">const</span> * path );
<a name="l00156"></a>00156 <span class="keywordtype">void</span> record_stats( <span class="keyword">struct</span> inotify_event <span class="keyword">const</span> * event );
<a name="l00157"></a>00157 <span class="keywordtype">int</span> onestr_to_event(<span class="keywordtype">char</span> <span class="keyword">const</span> * event);
<a name="l00158"></a>00158 
<a name="l00176"></a>00176 <span class="preprocessor">#define niceassert(cond,mesg) _niceassert((long)cond, __LINE__, __FILE__, \</span>
<a name="l00177"></a>00177 <span class="preprocessor">                                          #cond, mesg)</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>
<a name="l00179"></a>00179 <span class="preprocessor">#define nasprintf(...) niceassert( -1 != asprintf(__VA_ARGS__), &quot;out of memory&quot;)</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>
<a name="l00198"></a>00198 <span class="keyword">static</span> <span class="keywordtype">void</span> _niceassert( <span class="keywordtype">long</span> cond, <span class="keywordtype">int</span> line, <span class="keywordtype">char</span> <span class="keyword">const</span> * file,
<a name="l00199"></a>00199                   <span class="keywordtype">char</span> <span class="keyword">const</span> * condstr, <span class="keywordtype">char</span> <span class="keyword">const</span> * mesg ) {
<a name="l00200"></a>00200     <span class="keywordflow">if</span> ( cond ) <span class="keywordflow">return</span>;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="keywordflow">if</span> ( mesg ) {
<a name="l00203"></a>00203         fprintf(stderr, <span class="stringliteral">&quot;%s:%d assertion ( %s ) failed: %s\n&quot;</span>, file, line,
<a name="l00204"></a>00204                 condstr, mesg );
<a name="l00205"></a>00205     }
<a name="l00206"></a>00206     <span class="keywordflow">else</span> {
<a name="l00207"></a>00207         fprintf(stderr, <span class="stringliteral">&quot;%s:%d assertion ( %s ) failed.\n&quot;</span>, file, line, condstr);
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00220"></a>00220 <span class="keywordtype">char</span> * chrtostr(<span class="keywordtype">char</span> ch) {
<a name="l00221"></a>00221     <span class="keyword">static</span> <span class="keywordtype">char</span> str[2] = { <span class="charliteral">&apos;\0&apos;</span>, <span class="charliteral">&apos;\0&apos;</span> };
<a name="l00222"></a>00222     str[0] = ch;
<a name="l00223"></a>00223     <span class="keywordflow">return</span> str;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00229"></a>00229 <span class="keywordtype">int</span> read_num_from_file( <span class="keywordtype">char</span> * filename, <span class="keywordtype">int</span> * num ) {
<a name="l00230"></a>00230     FILE * file = fopen( filename, <span class="stringliteral">&quot;r&quot;</span> );
<a name="l00231"></a>00231     <span class="keywordflow">if</span> ( !file ) {
<a name="l00232"></a>00232         error = errno;
<a name="l00233"></a>00233         <span class="keywordflow">return</span> 0;
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="keywordflow">if</span> ( EOF == fscanf( file, <span class="stringliteral">&quot;%d&quot;</span>, num ) ) {
<a name="l00237"></a>00237         error = errno;
<a name="l00238"></a>00238         <span class="keywordflow">return</span> 0;
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     niceassert( 0 == fclose( file ), 0 );
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="keywordflow">return</span> 1;
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 <span class="keywordtype">int</span> wd_compare(<span class="keyword">const</span> <span class="keywordtype">void</span> *d1, <span class="keyword">const</span> <span class="keywordtype">void</span> *d2, <span class="keyword">const</span> <span class="keywordtype">void</span> *config) {
<a name="l00247"></a>00247     <span class="keywordflow">if</span> (!d1 || !d2) <span class="keywordflow">return</span> d1 - d2;
<a name="l00248"></a>00248     <span class="keywordflow">return</span> ((watch*)d1)-&gt;wd - ((watch*)d2)-&gt;wd;
<a name="l00249"></a>00249 }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251 <span class="keywordtype">int</span> filename_compare(<span class="keyword">const</span> <span class="keywordtype">void</span> *d1, <span class="keyword">const</span> <span class="keywordtype">void</span> *d2, <span class="keyword">const</span> <span class="keywordtype">void</span> *config) {
<a name="l00252"></a>00252     <span class="keywordflow">if</span> (!d1 || !d2) <span class="keywordflow">return</span> d1 - d2;
<a name="l00253"></a>00253     <span class="keywordflow">return</span> strcmp(((watch*)d1)-&gt;filename, ((watch*)d2)-&gt;filename);
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00259"></a>00259 watch *watch_from_wd( <span class="keywordtype">int</span> wd ) {
<a name="l00260"></a>00260     watch w;
<a name="l00261"></a>00261     w.wd = wd;
<a name="l00262"></a>00262     <span class="keywordflow">return</span> (watch*)rbfind(&amp;w, tree_wd);
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00268"></a>00268 watch *watch_from_filename( <span class="keywordtype">char</span> <span class="keyword">const</span> *filename ) {
<a name="l00269"></a>00269     watch w;
<a name="l00270"></a>00270     w.filename = (<span class="keywordtype">char</span>*)filename;
<a name="l00271"></a>00271     <span class="keywordflow">return</span> (watch*)rbfind(&amp;w, tree_filename);
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00283"></a><a class="code" href="inotifytools_8h.html#a3765c7874caeb0732926f34ae3c3cd63">00283</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a3765c7874caeb0732926f34ae3c3cd63">inotifytools_initialize</a>() {
<a name="l00284"></a>00284     <span class="keywordflow">if</span> (init) <span class="keywordflow">return</span> 1;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     error = 0;
<a name="l00287"></a>00287     <span class="comment">// Try to initialise inotify</span>
<a name="l00288"></a>00288     inotify_fd = inotify_init();
<a name="l00289"></a>00289     <span class="keywordflow">if</span> (inotify_fd &lt; 0) {
<a name="l00290"></a>00290         error = errno;
<a name="l00291"></a>00291         <span class="keywordflow">return</span> 0;
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     collect_stats = 0;
<a name="l00295"></a>00295     init = 1;
<a name="l00296"></a>00296     tree_wd = rbinit(wd_compare, 0);
<a name="l00297"></a>00297     tree_filename = rbinit(filename_compare, 0);
<a name="l00298"></a>00298     timefmt = 0;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <span class="keywordflow">return</span> 1;
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 
<a name="l00306"></a>00306 <span class="keywordtype">void</span> destroy_watch(watch *w) {
<a name="l00307"></a>00307     <span class="keywordflow">if</span> (w-&gt;filename) free(w-&gt;filename);
<a name="l00308"></a>00308     free(w);
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00314"></a>00314 <span class="keywordtype">void</span> cleanup_tree(<span class="keyword">const</span> <span class="keywordtype">void</span> *nodep,
<a name="l00315"></a>00315                  <span class="keyword">const</span> VISIT which,
<a name="l00316"></a>00316                  <span class="keyword">const</span> <span class="keywordtype">int</span> depth, <span class="keywordtype">void</span>* arg) {
<a name="l00317"></a>00317     <span class="keywordflow">if</span> (which != endorder &amp;&amp; which != leaf) <span class="keywordflow">return</span>;
<a name="l00318"></a>00318     watch *w = (watch*)nodep;
<a name="l00319"></a>00319     destroy_watch(w);
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00328"></a><a class="code" href="inotifytools_8h.html#a7efdc91ac4b26c374d287aa11b3af994">00328</a> <span class="keywordtype">void</span> <a class="code" href="inotifytools_8h.html#a7efdc91ac4b26c374d287aa11b3af994">inotifytools_cleanup</a>() {
<a name="l00329"></a>00329     <span class="keywordflow">if</span> (!init) <span class="keywordflow">return</span>;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     init = 0;
<a name="l00332"></a>00332     close(inotify_fd);
<a name="l00333"></a>00333     collect_stats = 0;
<a name="l00334"></a>00334     error = 0;
<a name="l00335"></a>00335     timefmt = 0;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="keywordflow">if</span> (regex) {
<a name="l00338"></a>00338         regfree(regex);
<a name="l00339"></a>00339         free(regex);
<a name="l00340"></a>00340         regex = 0;
<a name="l00341"></a>00341     }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     rbwalk(tree_wd, cleanup_tree, 0);
<a name="l00344"></a>00344     rbdestroy(tree_wd); tree_wd = 0;
<a name="l00345"></a>00345     rbdestroy(tree_filename); tree_filename = 0;
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00351"></a>00351 <span class="keywordtype">void</span> empty_stats(<span class="keyword">const</span> <span class="keywordtype">void</span> *nodep,
<a name="l00352"></a>00352                  <span class="keyword">const</span> VISIT which,
<a name="l00353"></a>00353                  <span class="keyword">const</span> <span class="keywordtype">int</span> depth, <span class="keywordtype">void</span> *arg) {
<a name="l00354"></a>00354     <span class="keywordflow">if</span> (which != endorder &amp;&amp; which != leaf) <span class="keywordflow">return</span>;
<a name="l00355"></a>00355     watch *w = (watch*)nodep;
<a name="l00356"></a>00356     w-&gt;hit_access = 0;
<a name="l00357"></a>00357     w-&gt;hit_modify = 0;
<a name="l00358"></a>00358     w-&gt;hit_attrib = 0;
<a name="l00359"></a>00359     w-&gt;hit_close_nowrite = 0;
<a name="l00360"></a>00360     w-&gt;hit_close_write = 0;
<a name="l00361"></a>00361     w-&gt;hit_open = 0;
<a name="l00362"></a>00362     w-&gt;hit_move_self = 0;
<a name="l00363"></a>00363     w-&gt;hit_moved_from = 0;
<a name="l00364"></a>00364     w-&gt;hit_moved_to = 0;
<a name="l00365"></a>00365     w-&gt;hit_create = 0;
<a name="l00366"></a>00366     w-&gt;hit_delete = 0;
<a name="l00367"></a>00367     w-&gt;hit_delete_self = 0;
<a name="l00368"></a>00368     w-&gt;hit_unmount = 0;
<a name="l00369"></a>00369     w-&gt;hit_total = 0;
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
<a name="l00375"></a>00375 <span class="keywordtype">void</span> replace_filename(<span class="keyword">const</span> <span class="keywordtype">void</span> *nodep,
<a name="l00376"></a>00376                       <span class="keyword">const</span> VISIT which,
<a name="l00377"></a>00377                       <span class="keyword">const</span> <span class="keywordtype">int</span> depth, <span class="keywordtype">void</span> *arg) {
<a name="l00378"></a>00378     <span class="keywordflow">if</span> (which != endorder &amp;&amp; which != leaf) <span class="keywordflow">return</span>;
<a name="l00379"></a>00379     watch *w = (watch*)nodep;
<a name="l00380"></a>00380     <span class="keywordtype">char</span> *old_name = ((<span class="keywordtype">char</span>**)arg)[0];
<a name="l00381"></a>00381     <span class="keywordtype">char</span> *new_name = ((<span class="keywordtype">char</span>**)arg)[1];
<a name="l00382"></a>00382     <span class="keywordtype">int</span> old_len = *((<span class="keywordtype">int</span>*)&amp;((<span class="keywordtype">char</span>**)arg)[2]);
<a name="l00383"></a>00383     <span class="keywordtype">char</span> *name;
<a name="l00384"></a>00384     <span class="keywordflow">if</span> ( 0 == strncmp( old_name, w-&gt;filename, old_len ) ) {
<a name="l00385"></a>00385         nasprintf( &amp;name, <span class="stringliteral">&quot;%s%s&quot;</span>, new_name, &amp;(w-&gt;filename[old_len]) );
<a name="l00386"></a>00386         <span class="keywordflow">if</span> (!strcmp( w-&gt;filename, new_name )) {
<a name="l00387"></a>00387             free(name);
<a name="l00388"></a>00388         } <span class="keywordflow">else</span> {
<a name="l00389"></a>00389             rbdelete(w, tree_filename);
<a name="l00390"></a>00390             free( w-&gt;filename );
<a name="l00391"></a>00391             w-&gt;filename = name;
<a name="l00392"></a>00392             rbsearch(w, tree_filename);
<a name="l00393"></a>00393         }
<a name="l00394"></a>00394     }
<a name="l00395"></a>00395 }
<a name="l00396"></a>00396 
<a name="l00400"></a>00400 <span class="keywordtype">void</span> get_num(<span class="keyword">const</span> <span class="keywordtype">void</span> *nodep,
<a name="l00401"></a>00401              <span class="keyword">const</span> VISIT which,
<a name="l00402"></a>00402              <span class="keyword">const</span> <span class="keywordtype">int</span> depth, <span class="keywordtype">void</span> *arg) {
<a name="l00403"></a>00403     <span class="keywordflow">if</span> (which != endorder &amp;&amp; which != leaf) <span class="keywordflow">return</span>;
<a name="l00404"></a>00404     ++(*((<span class="keywordtype">int</span>*)arg));
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 
<a name="l00420"></a><a class="code" href="inotifytools_8h.html#ae25cb60b12e3555795f55fb8c55db692">00420</a> <span class="keywordtype">void</span> <a class="code" href="inotifytools_8h.html#ae25cb60b12e3555795f55fb8c55db692">inotifytools_initialize_stats</a>() {
<a name="l00421"></a>00421     niceassert( init, <span class="stringliteral">&quot;inotifytools_initialize not called yet&quot;</span> );
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     <span class="comment">// if already collecting stats, reset stats</span>
<a name="l00424"></a>00424     <span class="keywordflow">if</span> (collect_stats) {
<a name="l00425"></a>00425         rbwalk(tree_wd, empty_stats, 0);
<a name="l00426"></a>00426     }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     num_access = 0;
<a name="l00429"></a>00429     num_modify = 0;
<a name="l00430"></a>00430     num_attrib = 0;
<a name="l00431"></a>00431     num_close_nowrite = 0;
<a name="l00432"></a>00432     num_close_write = 0;
<a name="l00433"></a>00433     num_open = 0;
<a name="l00434"></a>00434     num_move_self = 0;
<a name="l00435"></a>00435     num_moved_from = 0;
<a name="l00436"></a>00436     num_moved_to = 0;
<a name="l00437"></a>00437     num_create = 0;
<a name="l00438"></a>00438     num_delete = 0;
<a name="l00439"></a>00439     num_delete_self = 0;
<a name="l00440"></a>00440     num_unmount = 0;
<a name="l00441"></a>00441     num_total = 0;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     collect_stats = 1;
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00473"></a><a class="code" href="inotifytools_8h.html#a7e26c94c983d93669813c439883b334f">00473</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a7e26c94c983d93669813c439883b334f">inotifytools_str_to_event_sep</a>(<span class="keywordtype">char</span> <span class="keyword">const</span> * event, <span class="keywordtype">char</span> sep) {
<a name="l00474"></a>00474     <span class="keywordflow">if</span> ( strchr( <span class="stringliteral">&quot;_&quot;</span> <span class="stringliteral">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>
<a name="l00475"></a>00475                      <span class="stringliteral">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>, sep ) ) {
<a name="l00476"></a>00476         <span class="keywordflow">return</span> -1;
<a name="l00477"></a>00477     }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     <span class="keywordtype">int</span> ret, ret1, len;
<a name="l00480"></a>00480     <span class="keywordtype">char</span> * event1, * event2;
<a name="l00481"></a>00481     <span class="keywordtype">char</span> eventstr[4096];
<a name="l00482"></a>00482     ret = 0;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="keywordflow">if</span> ( !event || !event[0] ) <span class="keywordflow">return</span> 0;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486     event1 = (<span class="keywordtype">char</span> *)event;
<a name="l00487"></a>00487     event2 = strchr( event1, sep );
<a name="l00488"></a>00488     <span class="keywordflow">while</span> ( event1 &amp;&amp; event1[0] ) {
<a name="l00489"></a>00489         <span class="keywordflow">if</span> ( event2 ) {
<a name="l00490"></a>00490             len = event2 - event1;
<a name="l00491"></a>00491             niceassert( len &lt; 4096, <span class="stringliteral">&quot;malformed event string (very long)&quot;</span> );
<a name="l00492"></a>00492         }
<a name="l00493"></a>00493         <span class="keywordflow">else</span> {
<a name="l00494"></a>00494             len = strlen(event1);
<a name="l00495"></a>00495         }
<a name="l00496"></a>00496         <span class="keywordflow">if</span> ( len &gt; 4095 ) len = 4095;
<a name="l00497"></a>00497         strncpy( eventstr, event1, len );
<a name="l00498"></a>00498         eventstr[len] = 0;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500         ret1 = onestr_to_event( eventstr );
<a name="l00501"></a>00501         <span class="keywordflow">if</span> ( 0 == ret1 || -1 == ret1 ) {
<a name="l00502"></a>00502             ret = ret1;
<a name="l00503"></a>00503             <span class="keywordflow">break</span>;
<a name="l00504"></a>00504         }
<a name="l00505"></a>00505         ret |= ret1;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507         event1 = event2;
<a name="l00508"></a>00508         <span class="keywordflow">if</span> ( event1 &amp;&amp; event1[0] ) {
<a name="l00509"></a>00509             <span class="comment">// jump over &apos;sep&apos; character</span>
<a name="l00510"></a>00510             ++event1;
<a name="l00511"></a>00511             <span class="comment">// if last character was &apos;sep&apos;...</span>
<a name="l00512"></a>00512             <span class="keywordflow">if</span> ( !event1[0] ) <span class="keywordflow">return</span> 0;
<a name="l00513"></a>00513             event2 = strchr( event1, sep );
<a name="l00514"></a>00514         }
<a name="l00515"></a>00515     }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517     <span class="keywordflow">return</span> ret;
<a name="l00518"></a>00518 }
<a name="l00519"></a>00519 
<a name="l00543"></a><a class="code" href="inotifytools_8h.html#ac5f03415912fa505bcb7f2caf9273b45">00543</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#ac5f03415912fa505bcb7f2caf9273b45">inotifytools_str_to_event</a>(<span class="keywordtype">char</span> <span class="keyword">const</span> * event) {
<a name="l00544"></a>00544     <span class="keywordflow">return</span> <a class="code" href="inotifytools_8h.html#a7e26c94c983d93669813c439883b334f">inotifytools_str_to_event_sep</a>( event, <span class="charliteral">&apos;,&apos;</span> );
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00558"></a>00558 <span class="keywordtype">int</span> onestr_to_event(<span class="keywordtype">char</span> <span class="keyword">const</span> * event)
<a name="l00559"></a>00559 {
<a name="l00560"></a>00560     <span class="keyword">static</span> <span class="keywordtype">int</span> ret;
<a name="l00561"></a>00561     ret = -1;
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <span class="keywordflow">if</span> ( !event || !event[0] )
<a name="l00564"></a>00564         ret = 0;
<a name="l00565"></a>00565     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;ACCESS&quot;</span>) )
<a name="l00566"></a>00566         ret = IN_ACCESS;
<a name="l00567"></a>00567     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;MODIFY&quot;</span>) )
<a name="l00568"></a>00568         ret = IN_MODIFY;
<a name="l00569"></a>00569     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;ATTRIB&quot;</span>) )
<a name="l00570"></a>00570         ret = IN_ATTRIB;
<a name="l00571"></a>00571     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;CLOSE_WRITE&quot;</span>) )
<a name="l00572"></a>00572         ret = IN_CLOSE_WRITE;
<a name="l00573"></a>00573     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;CLOSE_NOWRITE&quot;</span>) )
<a name="l00574"></a>00574         ret = IN_CLOSE_NOWRITE;
<a name="l00575"></a>00575     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;OPEN&quot;</span>) )
<a name="l00576"></a>00576         ret = IN_OPEN;
<a name="l00577"></a>00577     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;MOVED_FROM&quot;</span>) )
<a name="l00578"></a>00578         ret = IN_MOVED_FROM;
<a name="l00579"></a>00579     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;MOVED_TO&quot;</span>) )
<a name="l00580"></a>00580         ret = IN_MOVED_TO;
<a name="l00581"></a>00581     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;CREATE&quot;</span>) )
<a name="l00582"></a>00582         ret = IN_CREATE;
<a name="l00583"></a>00583     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;DELETE&quot;</span>) )
<a name="l00584"></a>00584         ret = IN_DELETE;
<a name="l00585"></a>00585     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;DELETE_SELF&quot;</span>) )
<a name="l00586"></a>00586         ret = IN_DELETE_SELF;
<a name="l00587"></a>00587     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;UNMOUNT&quot;</span>) )
<a name="l00588"></a>00588         ret = IN_UNMOUNT;
<a name="l00589"></a>00589     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;Q_OVERFLOW&quot;</span>) )
<a name="l00590"></a>00590         ret = IN_Q_OVERFLOW;
<a name="l00591"></a>00591     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;IGNORED&quot;</span>) )
<a name="l00592"></a>00592         ret = IN_IGNORED;
<a name="l00593"></a>00593     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;CLOSE&quot;</span>) )
<a name="l00594"></a>00594         ret = IN_CLOSE;
<a name="l00595"></a>00595     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;MOVE_SELF&quot;</span>) )
<a name="l00596"></a>00596         ret = IN_MOVE_SELF;
<a name="l00597"></a>00597     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;MOVE&quot;</span>) )
<a name="l00598"></a>00598         ret = IN_MOVE;
<a name="l00599"></a>00599     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;ISDIR&quot;</span>) )
<a name="l00600"></a>00600         ret = IN_ISDIR;
<a name="l00601"></a>00601     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;ONESHOT&quot;</span>) )
<a name="l00602"></a>00602         ret = IN_ONESHOT;
<a name="l00603"></a>00603     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( 0 == strcasecmp(event, <span class="stringliteral">&quot;ALL_EVENTS&quot;</span>) )
<a name="l00604"></a>00604         ret = IN_ALL_EVENTS;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606     <span class="keywordflow">return</span> ret;
<a name="l00607"></a>00607 }
<a name="l00608"></a>00608 
<a name="l00630"></a><a class="code" href="inotifytools_8h.html#a744bb8792d8ea8edbaf8f845fe1d9307">00630</a> <span class="keywordtype">char</span> * <a class="code" href="inotifytools_8h.html#a744bb8792d8ea8edbaf8f845fe1d9307">inotifytools_event_to_str</a>(<span class="keywordtype">int</span> events)
<a name="l00631"></a>00631 {
<a name="l00632"></a>00632     <span class="keywordflow">return</span> <a class="code" href="inotifytools_8h.html#a317a5b1ea969f570a49c4549b22e7e71">inotifytools_event_to_str_sep</a>(events, <span class="charliteral">&apos;,&apos;</span>);
<a name="l00633"></a>00633 }
<a name="l00634"></a>00634 
<a name="l00635"></a>00635 
<a name="l00636"></a>00636 <span class="keyword">const</span> <span class="keywordtype">char</span> * inotifytools_event_to_str_safe(<span class="keywordtype">int</span> events, <span class="keywordtype">char</span> events_str[256])
<a name="l00637"></a>00637 {
<a name="l00638"></a>00638     <span class="keywordflow">return</span> inotifytools_event_to_str_sep_safe(events, <span class="stringliteral">&quot;,&quot;</span>, events_str);
<a name="l00639"></a>00639 }
<a name="l00640"></a>00640 
<a name="l00641"></a>00641 
<a name="l00666"></a><a class="code" href="inotifytools_8h.html#a317a5b1ea969f570a49c4549b22e7e71">00666</a> <span class="keywordtype">char</span> * <a class="code" href="inotifytools_8h.html#a317a5b1ea969f570a49c4549b22e7e71">inotifytools_event_to_str_sep</a>(<span class="keywordtype">int</span> events, <span class="keywordtype">char</span> sep)
<a name="l00667"></a>00667 {
<a name="l00668"></a>00668     <span class="keyword">static</span> <span class="keywordtype">char</span> ret[1024];
<a name="l00669"></a>00669     ret[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00670"></a>00670     ret[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     <span class="keywordflow">if</span> ( IN_ACCESS &amp; events ) {
<a name="l00673"></a>00673         strcat( ret, chrtostr(sep) );
<a name="l00674"></a>00674         strcat( ret, <span class="stringliteral">&quot;ACCESS&quot;</span> );
<a name="l00675"></a>00675     }
<a name="l00676"></a>00676     <span class="keywordflow">if</span> ( IN_MODIFY &amp; events ) {
<a name="l00677"></a>00677         strcat( ret, chrtostr(sep) );
<a name="l00678"></a>00678         strcat( ret, <span class="stringliteral">&quot;MODIFY&quot;</span> );
<a name="l00679"></a>00679     }
<a name="l00680"></a>00680     <span class="keywordflow">if</span> ( IN_ATTRIB &amp; events ) {
<a name="l00681"></a>00681         strcat( ret, chrtostr(sep) );
<a name="l00682"></a>00682         strcat( ret, <span class="stringliteral">&quot;ATTRIB&quot;</span> );
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684     <span class="keywordflow">if</span> ( IN_CLOSE_WRITE &amp; events ) {
<a name="l00685"></a>00685         strcat( ret, chrtostr(sep) );
<a name="l00686"></a>00686         strcat( ret, <span class="stringliteral">&quot;CLOSE_WRITE&quot;</span> );
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688     <span class="keywordflow">if</span> ( IN_CLOSE_NOWRITE &amp; events ) {
<a name="l00689"></a>00689         strcat( ret, chrtostr(sep) );
<a name="l00690"></a>00690         strcat( ret, <span class="stringliteral">&quot;CLOSE_NOWRITE&quot;</span> );
<a name="l00691"></a>00691     }
<a name="l00692"></a>00692     <span class="keywordflow">if</span> ( IN_OPEN &amp; events ) {
<a name="l00693"></a>00693         strcat( ret, chrtostr(sep) );
<a name="l00694"></a>00694         strcat( ret, <span class="stringliteral">&quot;OPEN&quot;</span> );
<a name="l00695"></a>00695     }
<a name="l00696"></a>00696     <span class="keywordflow">if</span> ( IN_MOVED_FROM &amp; events ) {
<a name="l00697"></a>00697         strcat( ret, chrtostr(sep) );
<a name="l00698"></a>00698         strcat( ret, <span class="stringliteral">&quot;MOVED_FROM&quot;</span> );
<a name="l00699"></a>00699     }
<a name="l00700"></a>00700     <span class="keywordflow">if</span> ( IN_MOVED_TO &amp; events ) {
<a name="l00701"></a>00701         strcat( ret, chrtostr(sep) );
<a name="l00702"></a>00702         strcat( ret, <span class="stringliteral">&quot;MOVED_TO&quot;</span> );
<a name="l00703"></a>00703     }
<a name="l00704"></a>00704     <span class="keywordflow">if</span> ( IN_CREATE &amp; events ) {
<a name="l00705"></a>00705         strcat( ret, chrtostr(sep) );
<a name="l00706"></a>00706         strcat( ret, <span class="stringliteral">&quot;CREATE&quot;</span> );
<a name="l00707"></a>00707     }
<a name="l00708"></a>00708     <span class="keywordflow">if</span> ( IN_DELETE &amp; events ) {
<a name="l00709"></a>00709         strcat( ret, chrtostr(sep) );
<a name="l00710"></a>00710         strcat( ret, <span class="stringliteral">&quot;DELETE&quot;</span> );
<a name="l00711"></a>00711     }
<a name="l00712"></a>00712     <span class="keywordflow">if</span> ( IN_DELETE_SELF &amp; events ) {
<a name="l00713"></a>00713         strcat( ret, chrtostr(sep) );
<a name="l00714"></a>00714         strcat( ret, <span class="stringliteral">&quot;DELETE_SELF&quot;</span> );
<a name="l00715"></a>00715     }
<a name="l00716"></a>00716     <span class="keywordflow">if</span> ( IN_UNMOUNT &amp; events ) {
<a name="l00717"></a>00717         strcat( ret, chrtostr(sep) );
<a name="l00718"></a>00718         strcat( ret, <span class="stringliteral">&quot;UNMOUNT&quot;</span> );
<a name="l00719"></a>00719     }
<a name="l00720"></a>00720     <span class="keywordflow">if</span> ( IN_Q_OVERFLOW &amp; events ) {
<a name="l00721"></a>00721         strcat( ret, chrtostr(sep) );
<a name="l00722"></a>00722         strcat( ret, <span class="stringliteral">&quot;Q_OVERFLOW&quot;</span> );
<a name="l00723"></a>00723     }
<a name="l00724"></a>00724     <span class="keywordflow">if</span> ( IN_IGNORED &amp; events ) {
<a name="l00725"></a>00725         strcat( ret, chrtostr(sep) );
<a name="l00726"></a>00726         strcat( ret, <span class="stringliteral">&quot;IGNORED&quot;</span> );
<a name="l00727"></a>00727     }
<a name="l00728"></a>00728     <span class="keywordflow">if</span> ( IN_CLOSE &amp; events ) {
<a name="l00729"></a>00729         strcat( ret, chrtostr(sep) );
<a name="l00730"></a>00730         strcat( ret, <span class="stringliteral">&quot;CLOSE&quot;</span> );
<a name="l00731"></a>00731     }
<a name="l00732"></a>00732     <span class="keywordflow">if</span> ( IN_MOVE_SELF &amp; events ) {
<a name="l00733"></a>00733         strcat( ret, chrtostr(sep) );
<a name="l00734"></a>00734         strcat( ret, <span class="stringliteral">&quot;MOVE_SELF&quot;</span> );
<a name="l00735"></a>00735     }
<a name="l00736"></a>00736     <span class="keywordflow">if</span> ( IN_ISDIR &amp; events ) {
<a name="l00737"></a>00737         strcat( ret, chrtostr(sep) );
<a name="l00738"></a>00738         strcat( ret, <span class="stringliteral">&quot;ISDIR&quot;</span> );
<a name="l00739"></a>00739     }
<a name="l00740"></a>00740     <span class="keywordflow">if</span> ( IN_ONESHOT &amp; events ) {
<a name="l00741"></a>00741         strcat( ret, chrtostr(sep) );
<a name="l00742"></a>00742         strcat( ret, <span class="stringliteral">&quot;ONESHOT&quot;</span> );
<a name="l00743"></a>00743     }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745     <span class="comment">// Maybe we didn&apos;t match any... ?</span>
<a name="l00746"></a>00746     <span class="keywordflow">if</span> (ret[0] == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l00747"></a>00747         niceassert( -1 != sprintf( ret, <span class="stringliteral">&quot;%c0x%08x&quot;</span>, sep, events ), 0 );
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750     <span class="keywordflow">return</span> &amp;ret[1];
<a name="l00751"></a>00751 }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753 
<a name="l00754"></a>00754 <span class="keyword">const</span> <span class="keywordtype">char</span> * inotifytools_event_to_str_sep_safe(<span class="keywordtype">int</span> events, <span class="keyword">const</span> <span class="keywordtype">char</span> *sep, <span class="keywordtype">char</span> ret[256])
<a name="l00755"></a>00755 {
<a name="l00756"></a>00756     ret[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00757"></a>00757     ret[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759     <span class="keywordflow">if</span> ( IN_ACCESS &amp; events ) {
<a name="l00760"></a>00760         strcat( ret, sep );
<a name="l00761"></a>00761         strcat( ret, <span class="stringliteral">&quot;ACCESS&quot;</span> );
<a name="l00762"></a>00762     }
<a name="l00763"></a>00763     <span class="keywordflow">if</span> ( IN_MODIFY &amp; events ) {
<a name="l00764"></a>00764         strcat( ret, sep );
<a name="l00765"></a>00765         strcat( ret, <span class="stringliteral">&quot;MODIFY&quot;</span> );
<a name="l00766"></a>00766     }
<a name="l00767"></a>00767     <span class="keywordflow">if</span> ( IN_ATTRIB &amp; events ) {
<a name="l00768"></a>00768         strcat( ret, sep );
<a name="l00769"></a>00769         strcat( ret, <span class="stringliteral">&quot;ATTRIB&quot;</span> );
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771     <span class="keywordflow">if</span> ( IN_CLOSE_WRITE &amp; events ) {
<a name="l00772"></a>00772         strcat( ret, sep );
<a name="l00773"></a>00773         strcat( ret, <span class="stringliteral">&quot;CLOSE_WRITE&quot;</span> );
<a name="l00774"></a>00774     }
<a name="l00775"></a>00775     <span class="keywordflow">if</span> ( IN_CLOSE_NOWRITE &amp; events ) {
<a name="l00776"></a>00776         strcat( ret, sep );
<a name="l00777"></a>00777         strcat( ret, <span class="stringliteral">&quot;CLOSE_NOWRITE&quot;</span> );
<a name="l00778"></a>00778     }
<a name="l00779"></a>00779     <span class="keywordflow">if</span> ( IN_OPEN &amp; events ) {
<a name="l00780"></a>00780         strcat( ret, sep );
<a name="l00781"></a>00781         strcat( ret, <span class="stringliteral">&quot;OPEN&quot;</span> );
<a name="l00782"></a>00782     }
<a name="l00783"></a>00783     <span class="keywordflow">if</span> ( IN_MOVED_FROM &amp; events ) {
<a name="l00784"></a>00784         strcat( ret, sep );
<a name="l00785"></a>00785         strcat( ret, <span class="stringliteral">&quot;MOVED_FROM&quot;</span> );
<a name="l00786"></a>00786     }
<a name="l00787"></a>00787     <span class="keywordflow">if</span> ( IN_MOVED_TO &amp; events ) {
<a name="l00788"></a>00788         strcat( ret, sep );
<a name="l00789"></a>00789         strcat( ret, <span class="stringliteral">&quot;MOVED_TO&quot;</span> );
<a name="l00790"></a>00790     }
<a name="l00791"></a>00791     <span class="keywordflow">if</span> ( IN_CREATE &amp; events ) {
<a name="l00792"></a>00792         strcat( ret, sep );
<a name="l00793"></a>00793         strcat( ret, <span class="stringliteral">&quot;CREATE&quot;</span> );
<a name="l00794"></a>00794     }
<a name="l00795"></a>00795     <span class="keywordflow">if</span> ( IN_DELETE &amp; events ) {
<a name="l00796"></a>00796         strcat( ret, sep );
<a name="l00797"></a>00797         strcat( ret, <span class="stringliteral">&quot;DELETE&quot;</span> );
<a name="l00798"></a>00798     }
<a name="l00799"></a>00799     <span class="keywordflow">if</span> ( IN_DELETE_SELF &amp; events ) {
<a name="l00800"></a>00800         strcat( ret, sep );
<a name="l00801"></a>00801         strcat( ret, <span class="stringliteral">&quot;DELETE_SELF&quot;</span> );
<a name="l00802"></a>00802     }
<a name="l00803"></a>00803     <span class="keywordflow">if</span> ( IN_UNMOUNT &amp; events ) {
<a name="l00804"></a>00804         strcat( ret, sep );
<a name="l00805"></a>00805         strcat( ret, <span class="stringliteral">&quot;UNMOUNT&quot;</span> );
<a name="l00806"></a>00806     }
<a name="l00807"></a>00807     <span class="keywordflow">if</span> ( IN_Q_OVERFLOW &amp; events ) {
<a name="l00808"></a>00808         strcat( ret, sep );
<a name="l00809"></a>00809         strcat( ret, <span class="stringliteral">&quot;Q_OVERFLOW&quot;</span> );
<a name="l00810"></a>00810     }
<a name="l00811"></a>00811     <span class="keywordflow">if</span> ( IN_IGNORED &amp; events ) {
<a name="l00812"></a>00812         strcat( ret, sep );
<a name="l00813"></a>00813         strcat( ret, <span class="stringliteral">&quot;IGNORED&quot;</span> );
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     <span class="keywordflow">if</span> ( IN_CLOSE &amp; events ) {
<a name="l00816"></a>00816         strcat( ret, sep );
<a name="l00817"></a>00817         strcat( ret, <span class="stringliteral">&quot;CLOSE&quot;</span> );
<a name="l00818"></a>00818     }
<a name="l00819"></a>00819     <span class="keywordflow">if</span> ( IN_MOVE_SELF &amp; events ) {
<a name="l00820"></a>00820         strcat( ret, sep );
<a name="l00821"></a>00821         strcat( ret, <span class="stringliteral">&quot;MOVE_SELF&quot;</span> );
<a name="l00822"></a>00822     }
<a name="l00823"></a>00823     <span class="keywordflow">if</span> ( IN_ISDIR &amp; events ) {
<a name="l00824"></a>00824         strcat( ret, sep );
<a name="l00825"></a>00825         strcat( ret, <span class="stringliteral">&quot;ISDIR&quot;</span> );
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827     <span class="keywordflow">if</span> ( IN_ONESHOT &amp; events ) {
<a name="l00828"></a>00828         strcat( ret, sep );
<a name="l00829"></a>00829         strcat( ret, <span class="stringliteral">&quot;ONESHOT&quot;</span> );
<a name="l00830"></a>00830     }
<a name="l00831"></a>00831 
<a name="l00832"></a>00832     <span class="comment">// Maybe we didn&apos;t match any... ?</span>
<a name="l00833"></a>00833     <span class="keywordflow">if</span> (ret[0] == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l00834"></a>00834         niceassert( -1 != sprintf( ret, <span class="stringliteral">&quot;%c0x%08x&quot;</span>, sep, events ), 0 );
<a name="l00835"></a>00835     }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837     <span class="keywordflow">return</span> &amp;ret[1];
<a name="l00838"></a>00838 }
<a name="l00839"></a>00839 
<a name="l00840"></a>00840 
<a name="l00861"></a><a class="code" href="inotifytools_8h.html#afd4dcc915248f2d0b0ae708e88611186">00861</a> <span class="keywordtype">char</span> * <a class="code" href="inotifytools_8h.html#afd4dcc915248f2d0b0ae708e88611186">inotifytools_filename_from_wd</a>( <span class="keywordtype">int</span> wd ) {
<a name="l00862"></a>00862     niceassert( init, <span class="stringliteral">&quot;inotifytools_initialize not called yet&quot;</span> );
<a name="l00863"></a>00863     watch *w = watch_from_wd(wd);
<a name="l00864"></a>00864     <span class="keywordflow">if</span> (!w)
<a name="l00865"></a>00865         <span class="keywordflow">return</span> NULL;
<a name="l00866"></a>00866 
<a name="l00867"></a>00867     <span class="keywordflow">return</span> w-&gt;filename;
<a name="l00868"></a>00868 }
<a name="l00869"></a>00869 
<a name="l00884"></a><a class="code" href="inotifytools_8h.html#a594e7f515b392c07c4f1f4eeffcda6c3">00884</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a594e7f515b392c07c4f1f4eeffcda6c3">inotifytools_wd_from_filename</a>( <span class="keywordtype">char</span> <span class="keyword">const</span> * filename ) {
<a name="l00885"></a>00885     niceassert( init, <span class="stringliteral">&quot;inotifytools_initialize not called yet&quot;</span> );
<a name="l00886"></a>00886     watch *w = watch_from_filename(filename);
<a name="l00887"></a>00887     <span class="keywordflow">if</span> (!w) <span class="keywordflow">return</span> -1;
<a name="l00888"></a>00888     <span class="keywordflow">return</span> w-&gt;wd;
<a name="l00889"></a>00889 }
<a name="l00890"></a>00890 
<a name="l00905"></a><a class="code" href="inotifytools_8h.html#af80acc2952c748a80641926ff222571c">00905</a> <span class="keywordtype">void</span> <a class="code" href="inotifytools_8h.html#af80acc2952c748a80641926ff222571c">inotifytools_set_filename_by_wd</a>( <span class="keywordtype">int</span> wd, <span class="keywordtype">char</span> <span class="keyword">const</span> * filename ) {
<a name="l00906"></a>00906     niceassert( init, <span class="stringliteral">&quot;inotifytools_initialize not called yet&quot;</span> );
<a name="l00907"></a>00907     watch *w = watch_from_wd(wd);
<a name="l00908"></a>00908     <span class="keywordflow">if</span> (!w) <span class="keywordflow">return</span>;
<a name="l00909"></a>00909     <span class="keywordflow">if</span> (w-&gt;filename) free(w-&gt;filename);
<a name="l00910"></a>00910     w-&gt;filename = strdup(filename);
<a name="l00911"></a>00911 }
<a name="l00912"></a>00912 
<a name="l00927"></a><a class="code" href="inotifytools_8h.html#a764239f33bd2a092c445362e75828181">00927</a> <span class="keywordtype">void</span> <a class="code" href="inotifytools_8h.html#a764239f33bd2a092c445362e75828181">inotifytools_set_filename_by_filename</a>( <span class="keywordtype">char</span> <span class="keyword">const</span> * oldname,
<a name="l00928"></a>00928                                             <span class="keywordtype">char</span> <span class="keyword">const</span> * newname ) {
<a name="l00929"></a>00929     watch *w = watch_from_filename(oldname);
<a name="l00930"></a>00930     <span class="keywordflow">if</span> (!w) <span class="keywordflow">return</span>;
<a name="l00931"></a>00931     <span class="keywordflow">if</span> (w-&gt;filename) free(w-&gt;filename);
<a name="l00932"></a>00932     w-&gt;filename = strdup(newname);
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 
<a name="l00957"></a><a class="code" href="inotifytools_8h.html#ac6f5ecf6f3d854535132fe9790db008d">00957</a> <span class="keywordtype">void</span> <a class="code" href="inotifytools_8h.html#ac6f5ecf6f3d854535132fe9790db008d">inotifytools_replace_filename</a>( <span class="keywordtype">char</span> <span class="keyword">const</span> * oldname,
<a name="l00958"></a>00958                                     <span class="keywordtype">char</span> <span class="keyword">const</span> * newname ) {
<a name="l00959"></a>00959     <span class="keywordflow">if</span> ( !oldname || !newname ) <span class="keywordflow">return</span>;
<a name="l00960"></a>00960     <span class="keywordtype">char</span> *names[2+<span class="keyword">sizeof</span>(int)/<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>*)];
<a name="l00961"></a>00961     names[0] = (<span class="keywordtype">char</span>*)oldname;
<a name="l00962"></a>00962     names[1] = (<span class="keywordtype">char</span>*)newname;
<a name="l00963"></a>00963     *((<span class="keywordtype">int</span>*)&amp;names[2]) = strlen(oldname);
<a name="l00964"></a>00964     rbwalk(tree_filename, replace_filename, (<span class="keywordtype">void</span>*)names);
<a name="l00965"></a>00965 }
<a name="l00966"></a>00966 
<a name="l00970"></a>00970 <span class="keywordtype">int</span> remove_inotify_watch(watch *w) {
<a name="l00971"></a>00971     error = 0;
<a name="l00972"></a>00972     <span class="keywordtype">int</span> status = inotify_rm_watch( inotify_fd, w-&gt;wd );
<a name="l00973"></a>00973     <span class="keywordflow">if</span> ( status &lt; 0 ) {
<a name="l00974"></a>00974         fprintf(stderr, <span class="stringliteral">&quot;Failed to remove watch on %s: %s\n&quot;</span>, w-&gt;filename, strerror(errno));
<a name="l00975"></a>00975 
<a name="l00976"></a>00976         <span class="keywordflow">if</span> (errno == EINVAL) {
<a name="l00977"></a>00977             <span class="comment">/* fixbug: The watch descriptor wd is not valid; or fd is not an inotify file descriptor. */</span>
<a name="l00978"></a>00978             <span class="keywordflow">return</span> 1;
<a name="l00979"></a>00979         }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981         error = status;
<a name="l00982"></a>00982         <span class="keywordflow">return</span> 0;
<a name="l00983"></a>00983     }
<a name="l00984"></a>00984 
<a name="l00985"></a>00985     <span class="keywordflow">return</span> 1;
<a name="l00986"></a>00986 }
<a name="l00987"></a>00987 
<a name="l00991"></a>00991 watch *create_watch(<span class="keywordtype">int</span> wd, <span class="keywordtype">char</span> *filename) {
<a name="l00992"></a>00992     <span class="keywordflow">if</span> ( wd &lt;= 0 || !filename) <span class="keywordflow">return</span> 0;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994     watch *w = (watch*)calloc(1, <span class="keyword">sizeof</span>(watch));
<a name="l00995"></a>00995     w-&gt;wd = wd;
<a name="l00996"></a>00996     w-&gt;filename = strdup(filename);
<a name="l00997"></a>00997     rbsearch(w, tree_wd);
<a name="l00998"></a>00998     rbsearch(w, tree_filename);
<a name="l00999"></a>00999 }
<a name="l01000"></a>01000 
<a name="l01013"></a><a class="code" href="inotifytools_8h.html#a771f60d2232201c691fe725d5cf7e019">01013</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a771f60d2232201c691fe725d5cf7e019">inotifytools_remove_watch_by_wd</a>( <span class="keywordtype">int</span> wd ) {
<a name="l01014"></a>01014     <span class="keywordtype">int</span> result = 1;
<a name="l01015"></a>01015     niceassert( init, <span class="stringliteral">&quot;inotifytools_initialize not called yet&quot;</span> );
<a name="l01016"></a>01016     watch *w = watch_from_wd(wd);
<a name="l01017"></a>01017     <span class="keywordflow">if</span> (!w) <span class="keywordflow">return</span> 1;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019     <span class="comment">/* fixbug: if (!remove_inotify_watch(w)) return 0; */</span>
<a name="l01020"></a>01020     <span class="keywordflow">if</span> (!remove_inotify_watch(w)) result = 0;
<a name="l01021"></a>01021     rbdelete(w, tree_wd);
<a name="l01022"></a>01022     rbdelete(w, tree_filename);
<a name="l01023"></a>01023     destroy_watch(w);
<a name="l01024"></a>01024     <span class="keywordflow">return</span> result;
<a name="l01025"></a>01025 }
<a name="l01026"></a>01026 
<a name="l01038"></a><a class="code" href="inotifytools_8h.html#a2a4ca66a9d8b0825d4272cd5003a9a0f">01038</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a2a4ca66a9d8b0825d4272cd5003a9a0f">inotifytools_remove_watch_by_filename</a>( <span class="keywordtype">char</span> <span class="keyword">const</span> * filename ) {
<a name="l01039"></a>01039     <span class="keywordtype">int</span> result = 1;
<a name="l01040"></a>01040     niceassert( init, <span class="stringliteral">&quot;inotifytools_initialize not called yet&quot;</span> );
<a name="l01041"></a>01041     watch *w = watch_from_filename(filename);
<a name="l01042"></a>01042     <span class="keywordflow">if</span> (!w) <span class="keywordflow">return</span> 1;
<a name="l01043"></a>01043 
<a name="l01044"></a>01044     <span class="comment">/* fixbug: if (!remove_inotify_watch(w)) return 0; */</span>
<a name="l01045"></a>01045     <span class="keywordflow">if</span> (!remove_inotify_watch(w)) result = 0;
<a name="l01046"></a>01046 
<a name="l01047"></a>01047     rbdelete(w, tree_wd);
<a name="l01048"></a>01048     rbdelete(w, tree_filename);
<a name="l01049"></a>01049     destroy_watch(w);
<a name="l01050"></a>01050     <span class="keywordflow">return</span> result;
<a name="l01051"></a>01051 }
<a name="l01052"></a>01052 
<a name="l01064"></a><a class="code" href="inotifytools_8h.html#a5e51d1c22c968f8c446ede5ff4caa901">01064</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a5e51d1c22c968f8c446ede5ff4caa901">inotifytools_watch_file</a>( <span class="keywordtype">char</span> <span class="keyword">const</span> * filename, <span class="keywordtype">int</span> events, ino_callback_t cbfunc, <span class="keywordtype">void</span> *cbarg ) {
<a name="l01065"></a>01065     <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span> * filenames[2];
<a name="l01066"></a>01066     filenames[0] = filename;
<a name="l01067"></a>01067     filenames[1] = NULL;
<a name="l01068"></a>01068     <span class="keywordflow">return</span> <a class="code" href="inotifytools_8h.html#a8e7c7a3f704f323ee197c1a3c65e8bb0">inotifytools_watch_files</a>( filenames, events, cbfunc, cbarg );
<a name="l01069"></a>01069 }
<a name="l01070"></a>01070 
<a name="l01086"></a><a class="code" href="inotifytools_8h.html#a8e7c7a3f704f323ee197c1a3c65e8bb0">01086</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a8e7c7a3f704f323ee197c1a3c65e8bb0">inotifytools_watch_files</a>( <span class="keywordtype">char</span> <span class="keyword">const</span> * filenames[], <span class="keywordtype">int</span> events, ino_callback_t cbfunc, <span class="keywordtype">void</span> *cbarg )
<a name="l01087"></a>01087 {
<a name="l01088"></a>01088     niceassert( init, <span class="stringliteral">&quot;inotifytools_initialize not called yet&quot;</span> );
<a name="l01089"></a>01089     error = 0;
<a name="l01090"></a>01090 
<a name="l01091"></a>01091     <span class="keyword">static</span> <span class="keywordtype">int</span> i;
<a name="l01092"></a>01092     <span class="keywordflow">for</span> ( i = 0; filenames[i]; ++i ) {
<a name="l01093"></a>01093         <span class="keyword">static</span> <span class="keywordtype">int</span> wd;
<a name="l01094"></a>01094 
<a name="l01095"></a>01095         <span class="keywordflow">if</span> (cbfunc) {
<a name="l01096"></a>01096             <span class="comment">// watch on query</span>
<a name="l01097"></a>01097             <span class="keywordflow">if</span> ( cbfunc(INO_WATCH_ON_QUERY, filenames[i], cbarg) ) {
<a name="l01098"></a>01098 
<a name="l01099"></a>01099                 wd = inotify_add_watch( inotify_fd, filenames[i], events );
<a name="l01100"></a>01100 
<a name="l01101"></a>01101                 <span class="keywordflow">if</span> ( wd &lt; 0 ) {
<a name="l01102"></a>01102                     <span class="comment">// watch on error</span>
<a name="l01103"></a>01103                     cbfunc(INO_WATCH_ON_ERROR, filenames[i], cbarg);
<a name="l01104"></a>01104 
<a name="l01105"></a>01105                     <span class="keywordflow">if</span> ( wd == -1 ) {
<a name="l01106"></a>01106                         error = errno;
<a name="l01107"></a>01107                         <span class="keywordflow">return</span> 0;
<a name="l01108"></a>01108                     } <span class="comment">// if ( wd == -1 )</span>
<a name="l01109"></a>01109                     <span class="keywordflow">else</span> {
<a name="l01110"></a>01110                         fprintf( stderr, <span class="stringliteral">&quot;Failed to watch %s: returned wd was %d &quot;</span>
<a name="l01111"></a>01111                                  <span class="stringliteral">&quot;(expected -1 or &gt;0 )&quot;</span>, filenames[i], wd );
<a name="l01112"></a>01112                         <span class="comment">// no appropriate value for error</span>
<a name="l01113"></a>01113                         <span class="keywordflow">return</span> 0;
<a name="l01114"></a>01114                     } <span class="comment">// else</span>
<a name="l01115"></a>01115                 } <span class="comment">// if ( wd &lt; 0 )</span>
<a name="l01116"></a>01116 
<a name="l01117"></a>01117                 <span class="keywordtype">char</span> *filename;
<a name="l01118"></a>01118 
<a name="l01119"></a>01119                 <span class="comment">// Always end filename with / if it is a directory</span>
<a name="l01120"></a>01120                 <span class="keywordflow">if</span> ( !isdir(filenames[i]) || filenames[i][strlen(filenames[i])-1] == <span class="charliteral">&apos;/&apos;</span>) {
<a name="l01121"></a>01121                     filename = strdup(filenames[i]);
<a name="l01122"></a>01122                 }
<a name="l01123"></a>01123                 <span class="keywordflow">else</span> {
<a name="l01124"></a>01124                     nasprintf( &amp;filename, <span class="stringliteral">&quot;%s/&quot;</span>, filenames[i] );
<a name="l01125"></a>01125                 }
<a name="l01126"></a>01126 
<a name="l01127"></a>01127                 create_watch(wd, filename);
<a name="l01128"></a>01128 
<a name="l01129"></a>01129                 <span class="comment">// watch is ready</span>
<a name="l01130"></a>01130                 cbfunc(INO_WATCH_ON_READY, filenames[i], cbarg);
<a name="l01131"></a>01131 
<a name="l01132"></a>01132                 free(filename);
<a name="l01133"></a>01133             }    
<a name="l01134"></a>01134         } <span class="keywordflow">else</span> {
<a name="l01135"></a>01135             wd = inotify_add_watch( inotify_fd, filenames[i], events );
<a name="l01136"></a>01136 
<a name="l01137"></a>01137             <span class="keywordflow">if</span> ( wd &lt; 0 ) {
<a name="l01138"></a>01138                 <span class="keywordflow">if</span> ( wd == -1 ) {
<a name="l01139"></a>01139                     error = errno;
<a name="l01140"></a>01140                     <span class="keywordflow">return</span> 0;
<a name="l01141"></a>01141                 } <span class="comment">// if ( wd == -1 )</span>
<a name="l01142"></a>01142                 <span class="keywordflow">else</span> {
<a name="l01143"></a>01143                     fprintf( stderr, <span class="stringliteral">&quot;Failed to watch %s: returned wd was %d &quot;</span>
<a name="l01144"></a>01144                              <span class="stringliteral">&quot;(expected -1 or &gt;0 )&quot;</span>, filenames[i], wd );
<a name="l01145"></a>01145                     <span class="comment">// no appropriate value for error</span>
<a name="l01146"></a>01146                     <span class="keywordflow">return</span> 0;
<a name="l01147"></a>01147                 } <span class="comment">// else</span>
<a name="l01148"></a>01148             } <span class="comment">// if ( wd &lt; 0 )</span>
<a name="l01149"></a>01149 
<a name="l01150"></a>01150             <span class="keywordtype">char</span> *filename;
<a name="l01151"></a>01151 
<a name="l01152"></a>01152             <span class="comment">// Always end filename with / if it is a directory</span>
<a name="l01153"></a>01153             <span class="keywordflow">if</span> ( !isdir(filenames[i]) || filenames[i][strlen(filenames[i])-1] == <span class="charliteral">&apos;/&apos;</span>) {
<a name="l01154"></a>01154                 filename = strdup(filenames[i]);
<a name="l01155"></a>01155             }
<a name="l01156"></a>01156             <span class="keywordflow">else</span> {
<a name="l01157"></a>01157                 nasprintf( &amp;filename, <span class="stringliteral">&quot;%s/&quot;</span>, filenames[i] );
<a name="l01158"></a>01158             }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160             create_watch(wd, filename);
<a name="l01161"></a>01161             free(filename);
<a name="l01162"></a>01162         }
<a name="l01163"></a>01163         
<a name="l01164"></a>01164     } <span class="comment">// for</span>
<a name="l01165"></a>01165 
<a name="l01166"></a>01166     <span class="keywordflow">return</span> 1;
<a name="l01167"></a>01167 }
<a name="l01168"></a>01168 
<a name="l01195"></a><a class="code" href="inotifytools_8h.html#acd99ad4277e4259b05eecc7fa51a715c">01195</a> <span class="keyword">struct </span>inotify_event * <a class="code" href="inotifytools_8h.html#acd99ad4277e4259b05eecc7fa51a715c">inotifytools_next_event</a>( <span class="keywordtype">long</span> <span class="keywordtype">int</span> timeout ) {
<a name="l01196"></a>01196     <span class="keywordflow">return</span> <a class="code" href="inotifytools_8h.html#a585a4532ebd9f441c0bc61ec29973a55">inotifytools_next_events</a>( timeout, 1 );
<a name="l01197"></a>01197 }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199 
<a name="l01248"></a><a class="code" href="inotifytools_8h.html#a585a4532ebd9f441c0bc61ec29973a55">01248</a> <span class="keyword">struct </span>inotify_event * <a class="code" href="inotifytools_8h.html#a585a4532ebd9f441c0bc61ec29973a55">inotifytools_next_events</a>( <span class="keywordtype">long</span> <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> num_events ) {
<a name="l01249"></a>01249     niceassert( init, <span class="stringliteral">&quot;inotifytools_initialize not called yet&quot;</span> );
<a name="l01250"></a>01250     niceassert( num_events &lt;= MAX_EVENTS, <span class="stringliteral">&quot;too many events requested&quot;</span> );
<a name="l01251"></a>01251 
<a name="l01252"></a>01252     <span class="keywordflow">if</span> ( num_events &lt; 1 ) <span class="keywordflow">return</span> NULL;
<a name="l01253"></a>01253 
<a name="l01254"></a>01254     <span class="keyword">static</span> <span class="keyword">struct </span>inotify_event event[MAX_EVENTS];
<a name="l01255"></a>01255     <span class="keyword">static</span> <span class="keyword">struct </span>inotify_event * ret;
<a name="l01256"></a>01256     <span class="keyword">static</span> <span class="keywordtype">int</span> first_byte = 0;
<a name="l01257"></a>01257     <span class="keyword">static</span> ssize_t bytes;
<a name="l01258"></a>01258     <span class="keyword">static</span> jmp_buf jmp;
<a name="l01259"></a>01259     <span class="keyword">static</span> <span class="keywordtype">char</span> match_name[MAX_STRLEN];
<a name="l01260"></a>01260 
<a name="l01261"></a>01261 <span class="preprocessor">#define RETURN(A) {\</span>
<a name="l01262"></a>01262 <span class="preprocessor">    if (regex) {\</span>
<a name="l01263"></a>01263 <span class="preprocessor">        inotifytools_snprintf(match_name, MAX_STRLEN, A, &quot;%w%f&quot;);\</span>
<a name="l01264"></a>01264 <span class="preprocessor">        if (0 == regexec(regex, match_name, 0, 0, 0)) {\</span>
<a name="l01265"></a>01265 <span class="preprocessor">            if (!invert_regexp)\</span>
<a name="l01266"></a>01266 <span class="preprocessor">                longjmp(jmp,0);\</span>
<a name="l01267"></a>01267 <span class="preprocessor">        } else {\</span>
<a name="l01268"></a>01268 <span class="preprocessor">            if (invert_regexp)\</span>
<a name="l01269"></a>01269 <span class="preprocessor">                longjmp(jmp,0);\</span>
<a name="l01270"></a>01270 <span class="preprocessor">        }\</span>
<a name="l01271"></a>01271 <span class="preprocessor">    }\</span>
<a name="l01272"></a>01272 <span class="preprocessor">    if ( collect_stats ) {\</span>
<a name="l01273"></a>01273 <span class="preprocessor">        record_stats( A );\</span>
<a name="l01274"></a>01274 <span class="preprocessor">    }\</span>
<a name="l01275"></a>01275 <span class="preprocessor">    return A;\</span>
<a name="l01276"></a>01276 <span class="preprocessor">}</span>
<a name="l01277"></a>01277 <span class="preprocessor"></span>
<a name="l01278"></a>01278     setjmp(jmp);
<a name="l01279"></a>01279 
<a name="l01280"></a>01280     error = 0;
<a name="l01281"></a>01281 
<a name="l01282"></a>01282     <span class="comment">// first_byte is index into event buffer</span>
<a name="l01283"></a>01283     <span class="keywordflow">if</span> ( first_byte != 0
<a name="l01284"></a>01284       &amp;&amp; first_byte &lt;= (<span class="keywordtype">int</span>)(bytes - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> inotify_event)) ) {
<a name="l01285"></a>01285 
<a name="l01286"></a>01286         ret = (<span class="keyword">struct </span>inotify_event *)((<span class="keywordtype">char</span> *)&amp;<span class="keyword">event</span>[0] + first_byte);
<a name="l01287"></a>01287         first_byte += <span class="keyword">sizeof</span>(<span class="keyword">struct </span>inotify_event) + ret-&gt;len;
<a name="l01288"></a>01288 
<a name="l01289"></a>01289         <span class="comment">// if the pointer to the next event exactly hits end of bytes read,</span>
<a name="l01290"></a>01290         <span class="comment">// that&apos;s good.  next time we&apos;re called, we&apos;ll read.</span>
<a name="l01291"></a>01291         <span class="keywordflow">if</span> ( first_byte == bytes ) {
<a name="l01292"></a>01292             first_byte = 0;
<a name="l01293"></a>01293         }
<a name="l01294"></a>01294         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( first_byte &gt; bytes ) {
<a name="l01295"></a>01295             <span class="comment">// oh... no.  this can&apos;t be happening.  An incomplete event.</span>
<a name="l01296"></a>01296             <span class="comment">// Copy what we currently have into first element, call self to</span>
<a name="l01297"></a>01297             <span class="comment">// read remainder.</span>
<a name="l01298"></a>01298             <span class="comment">// oh, and they BETTER NOT overlap.</span>
<a name="l01299"></a>01299             <span class="comment">// Boy I hope this code works.</span>
<a name="l01300"></a>01300             <span class="comment">// But I think this can never happen due to how inotify is written.</span>
<a name="l01301"></a>01301             niceassert( (<span class="keywordtype">long</span>)((<span class="keywordtype">char</span> *)&amp;event[0] +
<a name="l01302"></a>01302                         <span class="keyword">sizeof</span>(<span class="keyword">struct</span> inotify_event) +
<a name="l01303"></a>01303                         event[0].len) &lt;= (<span class="keywordtype">long</span>)ret,
<a name="l01304"></a>01304                         <span class="stringliteral">&quot;extremely unlucky user, death imminent&quot;</span> );
<a name="l01305"></a>01305             <span class="comment">// how much of the event do we have?</span>
<a name="l01306"></a>01306             bytes = (<span class="keywordtype">char</span> *)&amp;event[0] + bytes - (<span class="keywordtype">char</span> *)ret;
<a name="l01307"></a>01307             memcpy( &amp;event[0], ret, bytes );
<a name="l01308"></a>01308             <span class="keywordflow">return</span> <a class="code" href="inotifytools_8h.html#a585a4532ebd9f441c0bc61ec29973a55">inotifytools_next_events</a>( timeout, num_events );
<a name="l01309"></a>01309         }
<a name="l01310"></a>01310         RETURN(ret);
<a name="l01311"></a>01311 
<a name="l01312"></a>01312     }
<a name="l01313"></a>01313 
<a name="l01314"></a>01314     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( first_byte == 0 ) {
<a name="l01315"></a>01315         bytes = 0;
<a name="l01316"></a>01316     }
<a name="l01317"></a>01317 
<a name="l01318"></a>01318 
<a name="l01319"></a>01319     <span class="keyword">static</span> ssize_t this_bytes;
<a name="l01320"></a>01320     <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bytes_to_read;
<a name="l01321"></a>01321     <span class="keyword">static</span> <span class="keywordtype">int</span> rc;
<a name="l01322"></a>01322     <span class="keyword">static</span> fd_set read_fds;
<a name="l01323"></a>01323 
<a name="l01324"></a>01324     <span class="keyword">static</span> <span class="keyword">struct </span>timeval read_timeout;
<a name="l01325"></a>01325     read_timeout.tv_sec = timeout;
<a name="l01326"></a>01326     read_timeout.tv_usec = 0;
<a name="l01327"></a>01327     <span class="keyword">static</span> <span class="keyword">struct </span>timeval * read_timeout_ptr;
<a name="l01328"></a>01328     read_timeout_ptr = ( timeout &lt; 0 ? NULL : &amp;read_timeout );
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     FD_ZERO(&amp;read_fds);
<a name="l01331"></a>01331     FD_SET(inotify_fd, &amp;read_fds);
<a name="l01332"></a>01332     rc = select(inotify_fd + 1, &amp;read_fds,
<a name="l01333"></a>01333                 NULL, NULL, read_timeout_ptr);
<a name="l01334"></a>01334     <span class="keywordflow">if</span> ( rc &lt; 0 ) {
<a name="l01335"></a>01335         <span class="comment">// error</span>
<a name="l01336"></a>01336         error = errno;
<a name="l01337"></a>01337         <span class="keywordflow">return</span> NULL;
<a name="l01338"></a>01338     }
<a name="l01339"></a>01339     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( rc == 0 ) {
<a name="l01340"></a>01340         <span class="comment">// timeout</span>
<a name="l01341"></a>01341         <span class="keywordflow">return</span> NULL;
<a name="l01342"></a>01342     }
<a name="l01343"></a>01343 
<a name="l01344"></a>01344     <span class="comment">// wait until we have enough bytes to read</span>
<a name="l01345"></a>01345     <span class="keywordflow">do</span> {
<a name="l01346"></a>01346         rc = ioctl( inotify_fd, FIONREAD, &amp;bytes_to_read );
<a name="l01347"></a>01347     } <span class="keywordflow">while</span> ( !rc &amp;&amp;
<a name="l01348"></a>01348               bytes_to_read &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> inotify_event)*num_events );
<a name="l01349"></a>01349 
<a name="l01350"></a>01350     <span class="keywordflow">if</span> ( rc == -1 ) {
<a name="l01351"></a>01351         error = errno;
<a name="l01352"></a>01352         <span class="keywordflow">return</span> NULL;
<a name="l01353"></a>01353     }
<a name="l01354"></a>01354 
<a name="l01355"></a>01355     this_bytes = read(inotify_fd, &amp;event[0] + bytes,
<a name="l01356"></a>01356                       <span class="keyword">sizeof</span>(<span class="keyword">struct</span> inotify_event)*MAX_EVENTS - bytes);
<a name="l01357"></a>01357     <span class="keywordflow">if</span> ( this_bytes &lt; 0 ) {
<a name="l01358"></a>01358         error = errno;
<a name="l01359"></a>01359         <span class="keywordflow">return</span> NULL;
<a name="l01360"></a>01360     }
<a name="l01361"></a>01361     <span class="keywordflow">if</span> ( this_bytes == 0 ) {
<a name="l01362"></a>01362         fprintf(stderr, <span class="stringliteral">&quot;Inotify reported end-of-file.  Possibly too many &quot;</span>
<a name="l01363"></a>01363                         <span class="stringliteral">&quot;events occurred at once.\n&quot;</span>);
<a name="l01364"></a>01364         <span class="keywordflow">return</span> NULL;
<a name="l01365"></a>01365     }
<a name="l01366"></a>01366     bytes += this_bytes;
<a name="l01367"></a>01367 
<a name="l01368"></a>01368     ret = &amp;<span class="keyword">event</span>[0];
<a name="l01369"></a>01369     first_byte = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>inotify_event) + ret-&gt;len;
<a name="l01370"></a>01370     niceassert( first_byte &lt;= bytes, <span class="stringliteral">&quot;ridiculously long filename, things will &quot;</span>
<a name="l01371"></a>01371                                      <span class="stringliteral">&quot;almost certainly screw up.&quot;</span> );
<a name="l01372"></a>01372     <span class="keywordflow">if</span> ( first_byte == bytes ) {
<a name="l01373"></a>01373         first_byte = 0;
<a name="l01374"></a>01374     }
<a name="l01375"></a>01375 
<a name="l01376"></a>01376     RETURN(ret);
<a name="l01377"></a>01377 
<a name="l01378"></a>01378 <span class="preprocessor">#undef RETURN</span>
<a name="l01379"></a>01379 <span class="preprocessor"></span>}
<a name="l01380"></a>01380 
<a name="l01406"></a><a class="code" href="inotifytools_8h.html#a9092c1154cdf7885ddb70d65438379dd">01406</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a9092c1154cdf7885ddb70d65438379dd">inotifytools_watch_recursively</a>( <span class="keywordtype">char</span> <span class="keyword">const</span> * path, <span class="keywordtype">int</span> events, ino_callback_t cbfunc, <span class="keywordtype">void</span> *cbarg ) {
<a name="l01407"></a>01407     <span class="keywordflow">return</span> <a class="code" href="inotifytools_8h.html#a4262597ad6d28dc97db04b5663494e5c">inotifytools_watch_recursively_with_exclude</a>( path, events, 0, cbfunc, cbarg );
<a name="l01408"></a>01408 }
<a name="l01409"></a>01409 
<a name="l01442"></a><a class="code" href="inotifytools_8h.html#a4262597ad6d28dc97db04b5663494e5c">01442</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a4262597ad6d28dc97db04b5663494e5c">inotifytools_watch_recursively_with_exclude</a>( <span class="keywordtype">char</span> <span class="keyword">const</span> * path, <span class="keywordtype">int</span> events,
<a name="l01443"></a>01443     <span class="keywordtype">char</span> <span class="keyword">const</span> ** exclude_list,
<a name="l01444"></a>01444     ino_callback_t cbfunc, <span class="keywordtype">void</span> *cbarg ) {
<a name="l01445"></a>01445     niceassert( init, <span class="stringliteral">&quot;inotifytools_initialize not called yet&quot;</span> );
<a name="l01446"></a>01446 
<a name="l01447"></a>01447     DIR * dir;
<a name="l01448"></a>01448     <span class="keywordtype">char</span> * my_path;
<a name="l01449"></a>01449     error = 0;
<a name="l01450"></a>01450     dir = opendir( path );
<a name="l01451"></a>01451     <span class="keywordflow">if</span> ( !dir ) {
<a name="l01452"></a>01452         <span class="comment">// If not a directory, don&apos;t need to do anything special</span>
<a name="l01453"></a>01453         <span class="keywordflow">if</span> ( errno == ENOTDIR ) {
<a name="l01454"></a>01454             <span class="keywordflow">return</span> <a class="code" href="inotifytools_8h.html#a5e51d1c22c968f8c446ede5ff4caa901">inotifytools_watch_file</a>( path, events, cbfunc, cbarg );
<a name="l01455"></a>01455         }
<a name="l01456"></a>01456         <span class="keywordflow">else</span> {
<a name="l01457"></a>01457             error = errno;
<a name="l01458"></a>01458             <span class="keywordflow">return</span> 0;
<a name="l01459"></a>01459         }
<a name="l01460"></a>01460     }
<a name="l01461"></a>01461 
<a name="l01462"></a>01462     <span class="keywordflow">if</span> ( path[strlen(path)-1] != <span class="charliteral">&apos;/&apos;</span> ) {
<a name="l01463"></a>01463         nasprintf( &amp;my_path, <span class="stringliteral">&quot;%s/&quot;</span>, path );
<a name="l01464"></a>01464     }
<a name="l01465"></a>01465     <span class="keywordflow">else</span> {
<a name="l01466"></a>01466         my_path = (<span class="keywordtype">char</span> *)path;
<a name="l01467"></a>01467     }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469     <span class="keyword">static</span> <span class="keyword">struct </span>dirent * ent;
<a name="l01470"></a>01470     <span class="keywordtype">char</span> * next_file;
<a name="l01471"></a>01471     <span class="keyword">static</span> <span class="keyword">struct </span>stat64 my_stat;
<a name="l01472"></a>01472     ent = readdir( dir );
<a name="l01473"></a>01473     <span class="comment">// Watch each directory within this directory</span>
<a name="l01474"></a>01474     <span class="keywordflow">while</span> ( ent ) {
<a name="l01475"></a>01475         <span class="keywordflow">if</span> ( (0 != strcmp( ent-&gt;d_name, <span class="stringliteral">&quot;.&quot;</span> )) &amp;&amp;
<a name="l01476"></a>01476              (0 != strcmp( ent-&gt;d_name, <span class="stringliteral">&quot;..&quot;</span> )) ) {
<a name="l01477"></a>01477             nasprintf(&amp;next_file,<span class="stringliteral">&quot;%s%s&quot;</span>, my_path, ent-&gt;d_name);
<a name="l01478"></a>01478             <span class="keywordflow">if</span> ( -1 == lstat64( next_file, &amp;my_stat ) ) {
<a name="l01479"></a>01479                 error = errno;
<a name="l01480"></a>01480                 free( next_file );
<a name="l01481"></a>01481                 <span class="keywordflow">if</span> ( errno != EACCES ) {
<a name="l01482"></a>01482                     error = errno;
<a name="l01483"></a>01483                     <span class="keywordflow">if</span> ( my_path != path ) free( my_path );
<a name="l01484"></a>01484                     closedir( dir );
<a name="l01485"></a>01485                     <span class="keywordflow">return</span> 0;
<a name="l01486"></a>01486                 }
<a name="l01487"></a>01487             }
<a name="l01488"></a>01488             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( S_ISDIR( my_stat.st_mode ) &amp;&amp;
<a name="l01489"></a>01489                       !S_ISLNK( my_stat.st_mode )) {
<a name="l01490"></a>01490                 free( next_file );
<a name="l01491"></a>01491                 nasprintf(&amp;next_file,<span class="stringliteral">&quot;%s%s/&quot;</span>, my_path, ent-&gt;d_name);
<a name="l01492"></a>01492                 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> no_watch;
<a name="l01493"></a>01493                 <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span> ** exclude_entry;
<a name="l01494"></a>01494 
<a name="l01495"></a>01495                 no_watch = 0;
<a name="l01496"></a>01496                 <span class="keywordflow">for</span> (exclude_entry = exclude_list;
<a name="l01497"></a>01497                      exclude_entry &amp;&amp; *exclude_entry &amp;&amp; !no_watch;
<a name="l01498"></a>01498                      ++exclude_entry) {
<a name="l01499"></a>01499                     <span class="keyword">static</span> <span class="keywordtype">int</span> exclude_length;
<a name="l01500"></a>01500 
<a name="l01501"></a>01501                     exclude_length = strlen(*exclude_entry);
<a name="l01502"></a>01502                     <span class="keywordflow">if</span> ((*exclude_entry)[exclude_length-1] == <span class="charliteral">&apos;/&apos;</span>) {
<a name="l01503"></a>01503                         --exclude_length;
<a name="l01504"></a>01504                     }
<a name="l01505"></a>01505                     <span class="keywordflow">if</span> ( strlen(next_file) == (<span class="keywordtype">unsigned</span>)(exclude_length + 1) &amp;&amp;
<a name="l01506"></a>01506                         !strncmp(*exclude_entry, next_file, exclude_length)) {
<a name="l01507"></a>01507                         <span class="comment">// directory found in exclude list</span>
<a name="l01508"></a>01508                         no_watch = 1;
<a name="l01509"></a>01509                     }
<a name="l01510"></a>01510                 }
<a name="l01511"></a>01511                 <span class="keywordflow">if</span> (!no_watch) {
<a name="l01512"></a>01512                     <span class="keyword">static</span> <span class="keywordtype">int</span> status;
<a name="l01513"></a>01513                     status = <a class="code" href="inotifytools_8h.html#a4262597ad6d28dc97db04b5663494e5c">inotifytools_watch_recursively_with_exclude</a>(
<a name="l01514"></a>01514                                   next_file,
<a name="l01515"></a>01515                                   events,
<a name="l01516"></a>01516                                   exclude_list,
<a name="l01517"></a>01517                                   cbfunc, cbarg);
<a name="l01518"></a>01518 
<a name="l01519"></a>01519                     <span class="comment">// For some errors, we will continue.</span>
<a name="l01520"></a>01520                     <span class="keywordflow">if</span> ( !status &amp;&amp; (EACCES != error) &amp;&amp; (ENOENT != error) &amp;&amp;
<a name="l01521"></a>01521                          (ELOOP != error) ) {
<a name="l01522"></a>01522                         free( next_file );
<a name="l01523"></a>01523                         <span class="keywordflow">if</span> ( my_path != path ) free( my_path );
<a name="l01524"></a>01524                         closedir( dir );
<a name="l01525"></a>01525                         <span class="keywordflow">return</span> 0;
<a name="l01526"></a>01526                     }
<a name="l01527"></a>01527                 } <span class="comment">// if !no_watch</span>
<a name="l01528"></a>01528                 free( next_file );
<a name="l01529"></a>01529             } <span class="comment">// if isdir and not islnk</span>
<a name="l01530"></a>01530             <span class="keywordflow">else</span> {
<a name="l01531"></a>01531                 free( next_file );
<a name="l01532"></a>01532             }
<a name="l01533"></a>01533         }
<a name="l01534"></a>01534         ent = readdir( dir );
<a name="l01535"></a>01535         error = 0;
<a name="l01536"></a>01536     }
<a name="l01537"></a>01537 
<a name="l01538"></a>01538     closedir( dir );
<a name="l01539"></a>01539 
<a name="l01540"></a>01540     <span class="keywordtype">int</span> ret = <a class="code" href="inotifytools_8h.html#a5e51d1c22c968f8c446ede5ff4caa901">inotifytools_watch_file</a>( my_path, events, cbfunc, cbarg );
<a name="l01541"></a>01541 
<a name="l01542"></a>01542     <span class="keywordflow">if</span> ( my_path != path ) {
<a name="l01543"></a>01543         free( my_path );
<a name="l01544"></a>01544     }
<a name="l01545"></a>01545 
<a name="l01546"></a>01546     <span class="keywordflow">return</span> ret;
<a name="l01547"></a>01547 }
<a name="l01548"></a>01548 
<a name="l01552"></a>01552 <span class="keywordtype">void</span> record_stats( <span class="keyword">struct</span> inotify_event <span class="keyword">const</span> * event ) {
<a name="l01553"></a>01553     <span class="keywordflow">if</span> (!event) <span class="keywordflow">return</span>;
<a name="l01554"></a>01554     watch *w = watch_from_wd(event-&gt;wd);
<a name="l01555"></a>01555     <span class="keywordflow">if</span> (!w) <span class="keywordflow">return</span>;
<a name="l01556"></a>01556     <span class="keywordflow">if</span> ( IN_ACCESS &amp; event-&gt;mask ) {
<a name="l01557"></a>01557         ++w-&gt;hit_access;
<a name="l01558"></a>01558         ++num_access;
<a name="l01559"></a>01559     }
<a name="l01560"></a>01560     <span class="keywordflow">if</span> ( IN_MODIFY &amp; event-&gt;mask ) {
<a name="l01561"></a>01561         ++w-&gt;hit_modify;
<a name="l01562"></a>01562         ++num_modify;
<a name="l01563"></a>01563     }
<a name="l01564"></a>01564     <span class="keywordflow">if</span> ( IN_ATTRIB &amp; event-&gt;mask ) {
<a name="l01565"></a>01565         ++w-&gt;hit_attrib;
<a name="l01566"></a>01566         ++num_attrib;
<a name="l01567"></a>01567     }
<a name="l01568"></a>01568     <span class="keywordflow">if</span> ( IN_CLOSE_WRITE &amp; event-&gt;mask ) {
<a name="l01569"></a>01569         ++w-&gt;hit_close_write;
<a name="l01570"></a>01570         ++num_close_write;
<a name="l01571"></a>01571     }
<a name="l01572"></a>01572     <span class="keywordflow">if</span> ( IN_CLOSE_NOWRITE &amp; event-&gt;mask ) {
<a name="l01573"></a>01573         ++w-&gt;hit_close_nowrite;
<a name="l01574"></a>01574         ++num_close_nowrite;
<a name="l01575"></a>01575     }
<a name="l01576"></a>01576     <span class="keywordflow">if</span> ( IN_OPEN &amp; event-&gt;mask ) {
<a name="l01577"></a>01577         ++w-&gt;hit_open;
<a name="l01578"></a>01578         ++num_open;
<a name="l01579"></a>01579     }
<a name="l01580"></a>01580     <span class="keywordflow">if</span> ( IN_MOVED_FROM &amp; event-&gt;mask ) {
<a name="l01581"></a>01581         ++w-&gt;hit_moved_from;
<a name="l01582"></a>01582         ++num_moved_from;
<a name="l01583"></a>01583     }
<a name="l01584"></a>01584     <span class="keywordflow">if</span> ( IN_MOVED_TO &amp; event-&gt;mask ) {
<a name="l01585"></a>01585         ++w-&gt;hit_moved_to;
<a name="l01586"></a>01586         ++num_moved_to;
<a name="l01587"></a>01587     }
<a name="l01588"></a>01588     <span class="keywordflow">if</span> ( IN_CREATE &amp; event-&gt;mask ) {
<a name="l01589"></a>01589         ++w-&gt;hit_create;
<a name="l01590"></a>01590         ++num_create;
<a name="l01591"></a>01591     }
<a name="l01592"></a>01592     <span class="keywordflow">if</span> ( IN_DELETE &amp; event-&gt;mask ) {
<a name="l01593"></a>01593         ++w-&gt;hit_delete;
<a name="l01594"></a>01594         ++num_delete;
<a name="l01595"></a>01595     }
<a name="l01596"></a>01596     <span class="keywordflow">if</span> ( IN_DELETE_SELF &amp; event-&gt;mask ) {
<a name="l01597"></a>01597         ++w-&gt;hit_delete_self;
<a name="l01598"></a>01598         ++num_delete_self;
<a name="l01599"></a>01599     }
<a name="l01600"></a>01600     <span class="keywordflow">if</span> ( IN_UNMOUNT &amp; event-&gt;mask ) {
<a name="l01601"></a>01601         ++w-&gt;hit_unmount;
<a name="l01602"></a>01602         ++num_unmount;
<a name="l01603"></a>01603     }
<a name="l01604"></a>01604     <span class="keywordflow">if</span> ( IN_MOVE_SELF &amp; event-&gt;mask ) {
<a name="l01605"></a>01605         ++w-&gt;hit_move_self;
<a name="l01606"></a>01606         ++num_move_self;
<a name="l01607"></a>01607     }
<a name="l01608"></a>01608 
<a name="l01609"></a>01609     ++w-&gt;hit_total;
<a name="l01610"></a>01610     ++num_total;
<a name="l01611"></a>01611 
<a name="l01612"></a>01612 }
<a name="l01613"></a>01613 
<a name="l01614"></a>01614 <span class="keywordtype">int</span> *stat_ptr(watch *w, <span class="keywordtype">int</span> event)
<a name="l01615"></a>01615 {
<a name="l01616"></a>01616     <span class="keywordflow">if</span> ( 0 == event ) {
<a name="l01617"></a>01617         <span class="keywordflow">return</span> &amp;w-&gt;hit_total;
<a name="l01618"></a>01618     } <span class="keywordflow">else</span> {
<a name="l01619"></a>01619         <span class="keywordflow">switch</span> (event) {
<a name="l01620"></a>01620         <span class="keywordflow">case</span> IN_MODIFY:
<a name="l01621"></a>01621             <span class="keywordflow">return</span> &amp;w-&gt;hit_modify;
<a name="l01622"></a>01622         <span class="keywordflow">case</span> IN_CLOSE_WRITE:
<a name="l01623"></a>01623             <span class="keywordflow">return</span> &amp;w-&gt;hit_close_write;
<a name="l01624"></a>01624         <span class="keywordflow">case</span> IN_ACCESS:
<a name="l01625"></a>01625             <span class="keywordflow">return</span> &amp;w-&gt;hit_access;
<a name="l01626"></a>01626         <span class="keywordflow">case</span> IN_ATTRIB:
<a name="l01627"></a>01627             <span class="keywordflow">return</span> &amp;w-&gt;hit_attrib;
<a name="l01628"></a>01628         <span class="keywordflow">case</span> IN_CLOSE_NOWRITE:
<a name="l01629"></a>01629             <span class="keywordflow">return</span> &amp;w-&gt;hit_close_nowrite;
<a name="l01630"></a>01630         <span class="keywordflow">case</span> IN_OPEN:
<a name="l01631"></a>01631             <span class="keywordflow">return</span> &amp;w-&gt;hit_open;
<a name="l01632"></a>01632         <span class="keywordflow">case</span> IN_MOVED_FROM:
<a name="l01633"></a>01633             <span class="keywordflow">return</span> &amp;w-&gt;hit_moved_from;
<a name="l01634"></a>01634         <span class="keywordflow">case</span> IN_MOVED_TO:
<a name="l01635"></a>01635             <span class="keywordflow">return</span> &amp;w-&gt;hit_moved_to;
<a name="l01636"></a>01636         <span class="keywordflow">case</span> IN_CREATE:
<a name="l01637"></a>01637             <span class="keywordflow">return</span> &amp;w-&gt;hit_create;
<a name="l01638"></a>01638         <span class="keywordflow">case</span> IN_DELETE:
<a name="l01639"></a>01639             <span class="keywordflow">return</span> &amp;w-&gt;hit_delete;
<a name="l01640"></a>01640         <span class="keywordflow">case</span> IN_DELETE_SELF:
<a name="l01641"></a>01641             <span class="keywordflow">return</span> &amp;w-&gt;hit_delete_self;
<a name="l01642"></a>01642         <span class="keywordflow">case</span> IN_UNMOUNT:
<a name="l01643"></a>01643             <span class="keywordflow">return</span> &amp;w-&gt;hit_unmount;
<a name="l01644"></a>01644         <span class="keywordflow">case</span> IN_MOVE_SELF:
<a name="l01645"></a>01645             <span class="keywordflow">return</span> &amp;w-&gt;hit_move_self;
<a name="l01646"></a>01646         }
<a name="l01647"></a>01647 
<a name="l01648"></a>01648         <span class="keywordflow">return</span> 0;
<a name="l01649"></a>01649     }
<a name="l01650"></a>01650 }
<a name="l01651"></a>01651 
<a name="l01667"></a><a class="code" href="inotifytools_8h.html#a4d5002bd8504b70faed608886e0fa307">01667</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a4d5002bd8504b70faed608886e0fa307">inotifytools_get_stat_by_wd</a>( <span class="keywordtype">int</span> wd, <span class="keywordtype">int</span> event ) {
<a name="l01668"></a>01668     <span class="keywordflow">if</span> (!collect_stats) <span class="keywordflow">return</span> -1;
<a name="l01669"></a>01669 
<a name="l01670"></a>01670     watch *w = watch_from_wd(wd);
<a name="l01671"></a>01671     <span class="keywordflow">if</span> (!w) <span class="keywordflow">return</span> -1;
<a name="l01672"></a>01672     <span class="keywordtype">int</span> *i = stat_ptr(w, event);
<a name="l01673"></a>01673     <span class="keywordflow">if</span> (!i) <span class="keywordflow">return</span> -1;
<a name="l01674"></a>01674     <span class="keywordflow">return</span> *i;
<a name="l01675"></a>01675 }
<a name="l01676"></a>01676 
<a name="l01690"></a><a class="code" href="inotifytools_8h.html#af3de070bdf428d548e0b54f5e9043dcc">01690</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#af3de070bdf428d548e0b54f5e9043dcc">inotifytools_get_stat_total</a>( <span class="keywordtype">int</span> event ) {
<a name="l01691"></a>01691     <span class="keywordflow">if</span> (!collect_stats) <span class="keywordflow">return</span> -1;
<a name="l01692"></a>01692     <span class="keywordflow">if</span> ( IN_ACCESS == event )
<a name="l01693"></a>01693         <span class="keywordflow">return</span> num_access;
<a name="l01694"></a>01694     <span class="keywordflow">if</span> ( IN_MODIFY == event )
<a name="l01695"></a>01695         <span class="keywordflow">return</span> num_modify;
<a name="l01696"></a>01696     <span class="keywordflow">if</span> ( IN_ATTRIB == event )
<a name="l01697"></a>01697         <span class="keywordflow">return</span> num_attrib;
<a name="l01698"></a>01698     <span class="keywordflow">if</span> ( IN_CLOSE_WRITE == event )
<a name="l01699"></a>01699         <span class="keywordflow">return</span> num_close_write;
<a name="l01700"></a>01700     <span class="keywordflow">if</span> ( IN_CLOSE_NOWRITE == event )
<a name="l01701"></a>01701         <span class="keywordflow">return</span> num_close_nowrite;
<a name="l01702"></a>01702     <span class="keywordflow">if</span> ( IN_OPEN == event )
<a name="l01703"></a>01703         <span class="keywordflow">return</span> num_open;
<a name="l01704"></a>01704     <span class="keywordflow">if</span> ( IN_MOVED_FROM == event )
<a name="l01705"></a>01705         <span class="keywordflow">return</span> num_moved_from;
<a name="l01706"></a>01706     <span class="keywordflow">if</span> ( IN_MOVED_TO == event )
<a name="l01707"></a>01707         <span class="keywordflow">return</span> num_moved_to;
<a name="l01708"></a>01708     <span class="keywordflow">if</span> ( IN_CREATE == event )
<a name="l01709"></a>01709         <span class="keywordflow">return</span> num_create;
<a name="l01710"></a>01710     <span class="keywordflow">if</span> ( IN_DELETE == event )
<a name="l01711"></a>01711         <span class="keywordflow">return</span> num_delete;
<a name="l01712"></a>01712     <span class="keywordflow">if</span> ( IN_DELETE_SELF == event )
<a name="l01713"></a>01713         <span class="keywordflow">return</span> num_delete_self;
<a name="l01714"></a>01714     <span class="keywordflow">if</span> ( IN_UNMOUNT == event )
<a name="l01715"></a>01715         <span class="keywordflow">return</span> num_unmount;
<a name="l01716"></a>01716     <span class="keywordflow">if</span> ( IN_MOVE_SELF == event )
<a name="l01717"></a>01717         <span class="keywordflow">return</span> num_move_self;
<a name="l01718"></a>01718 
<a name="l01719"></a>01719     <span class="keywordflow">if</span> ( 0 == event )
<a name="l01720"></a>01720         <span class="keywordflow">return</span> num_total;
<a name="l01721"></a>01721 
<a name="l01722"></a>01722     <span class="keywordflow">return</span> -1;
<a name="l01723"></a>01723 }
<a name="l01724"></a>01724 
<a name="l01744"></a><a class="code" href="inotifytools_8h.html#a70bf8afcf5dce7d324d3a1a4cf48871a">01744</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a70bf8afcf5dce7d324d3a1a4cf48871a">inotifytools_get_stat_by_filename</a>( <span class="keywordtype">char</span> <span class="keyword">const</span> * filename,
<a name="l01745"></a>01745                                                 <span class="keywordtype">int</span> event ) {
<a name="l01746"></a>01746     <span class="keywordflow">return</span> <a class="code" href="inotifytools_8h.html#a4d5002bd8504b70faed608886e0fa307">inotifytools_get_stat_by_wd</a>( <a class="code" href="inotifytools_8h.html#a594e7f515b392c07c4f1f4eeffcda6c3">inotifytools_wd_from_filename</a>(
<a name="l01747"></a>01747            filename ), event );
<a name="l01748"></a>01748 }
<a name="l01749"></a>01749 
<a name="l01760"></a><a class="code" href="inotifytools_8h.html#a313399ccce221c8a5862892396d1a8ec">01760</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a313399ccce221c8a5862892396d1a8ec">inotifytools_error</a>() {
<a name="l01761"></a>01761     <span class="keywordflow">return</span> error;
<a name="l01762"></a>01762 }
<a name="l01763"></a>01763 
<a name="l01767"></a>01767 <span class="keyword">static</span> <span class="keywordtype">int</span> isdir( <span class="keywordtype">char</span> <span class="keyword">const</span> * path ) {
<a name="l01768"></a>01768     <span class="keyword">static</span> <span class="keyword">struct </span>stat64 my_stat;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770     <span class="keywordflow">if</span> ( -1 == lstat64( path, &amp;my_stat ) ) {
<a name="l01771"></a>01771         <span class="keywordflow">if</span> (errno == ENOENT) <span class="keywordflow">return</span> 0;
<a name="l01772"></a>01772         fprintf(stderr, <span class="stringliteral">&quot;Stat failed on %s: %s\n&quot;</span>, path, strerror(errno));
<a name="l01773"></a>01773         <span class="keywordflow">return</span> 0;
<a name="l01774"></a>01774     }
<a name="l01775"></a>01775 
<a name="l01776"></a>01776     <span class="keywordflow">return</span> S_ISDIR( my_stat.st_mode ) &amp;&amp; !S_ISLNK( my_stat.st_mode );
<a name="l01777"></a>01777 }
<a name="l01778"></a>01778 
<a name="l01779"></a>01779 
<a name="l01786"></a><a class="code" href="inotifytools_8h.html#aaf934e6f66eb02f3c6e72d65c9bd610c">01786</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#aaf934e6f66eb02f3c6e72d65c9bd610c">inotifytools_get_num_watches</a>() {
<a name="l01787"></a>01787     <span class="keywordtype">int</span> ret = 0;
<a name="l01788"></a>01788     rbwalk(tree_filename, get_num, (<span class="keywordtype">void</span>*)&amp;ret);
<a name="l01789"></a>01789     <span class="keywordflow">return</span> ret;
<a name="l01790"></a>01790 }
<a name="l01791"></a>01791 
<a name="l01832"></a><a class="code" href="inotifytools_8h.html#ac2c06dd72f39a6145ea3b6661378df31">01832</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#ac2c06dd72f39a6145ea3b6661378df31">inotifytools_printf</a>( <span class="keyword">struct</span> inotify_event* event, <span class="keywordtype">char</span>* fmt ) {
<a name="l01833"></a>01833     <span class="keywordflow">return</span> <a class="code" href="inotifytools_8h.html#a6ed4450ad545bde13a1328e53ed8cf6d">inotifytools_fprintf</a>( stdout, event, fmt );
<a name="l01834"></a>01834 }
<a name="l01835"></a>01835 
<a name="l01877"></a><a class="code" href="inotifytools_8h.html#a6ed4450ad545bde13a1328e53ed8cf6d">01877</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a6ed4450ad545bde13a1328e53ed8cf6d">inotifytools_fprintf</a>( FILE* file, <span class="keyword">struct</span> inotify_event* event, <span class="keywordtype">char</span>* fmt ) {
<a name="l01878"></a>01878     <span class="keyword">static</span> <span class="keywordtype">char</span> out[MAX_STRLEN+1];
<a name="l01879"></a>01879     <span class="keyword">static</span> <span class="keywordtype">int</span> ret;
<a name="l01880"></a>01880     ret = <a class="code" href="inotifytools_8h.html#aabf4cbafd50012f6e35b32a052677c74">inotifytools_sprintf</a>( out, event, fmt );
<a name="l01881"></a>01881     <span class="keywordflow">if</span> ( -1 != ret ) fprintf( file, <span class="stringliteral">&quot;%s&quot;</span>, out );
<a name="l01882"></a>01882     <span class="keywordflow">return</span> ret;
<a name="l01883"></a>01883 }
<a name="l01884"></a>01884 
<a name="l01935"></a><a class="code" href="inotifytools_8h.html#aabf4cbafd50012f6e35b32a052677c74">01935</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#aabf4cbafd50012f6e35b32a052677c74">inotifytools_sprintf</a>( <span class="keywordtype">char</span> * out, <span class="keyword">struct</span> inotify_event* event, <span class="keywordtype">char</span>* fmt ) {
<a name="l01936"></a>01936     <span class="keywordflow">return</span> <a class="code" href="inotifytools_8h.html#a92f2dc66af4fd01b09b64b6813686282">inotifytools_snprintf</a>( out, MAX_STRLEN, event, fmt );
<a name="l01937"></a>01937 }
<a name="l01938"></a>01938 
<a name="l01939"></a>01939 
<a name="l01986"></a><a class="code" href="inotifytools_8h.html#a92f2dc66af4fd01b09b64b6813686282">01986</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a92f2dc66af4fd01b09b64b6813686282">inotifytools_snprintf</a>( <span class="keywordtype">char</span> * out, <span class="keywordtype">int</span> size,
<a name="l01987"></a>01987                            <span class="keyword">struct</span> inotify_event* event, <span class="keywordtype">char</span>* fmt ) {
<a name="l01988"></a>01988     <span class="keyword">static</span> <span class="keywordtype">char</span> * filename, * eventname, * eventstr;
<a name="l01989"></a>01989     <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, ind;
<a name="l01990"></a>01990     <span class="keyword">static</span> <span class="keywordtype">char</span> ch1;
<a name="l01991"></a>01991     <span class="keyword">static</span> <span class="keywordtype">char</span> timestr[MAX_STRLEN];
<a name="l01992"></a>01992     <span class="keyword">static</span> time_t now;
<a name="l01993"></a>01993 
<a name="l01994"></a>01994 
<a name="l01995"></a>01995     <span class="keywordflow">if</span> ( event-&gt;len &gt; 0 ) {
<a name="l01996"></a>01996         eventname = <span class="keyword">event</span>-&gt;name;
<a name="l01997"></a>01997     }
<a name="l01998"></a>01998     <span class="keywordflow">else</span> {
<a name="l01999"></a>01999         eventname = NULL;
<a name="l02000"></a>02000     }
<a name="l02001"></a>02001 
<a name="l02002"></a>02002 
<a name="l02003"></a>02003     filename = <a class="code" href="inotifytools_8h.html#afd4dcc915248f2d0b0ae708e88611186">inotifytools_filename_from_wd</a>( event-&gt;wd );
<a name="l02004"></a>02004 
<a name="l02005"></a>02005     <span class="keywordflow">if</span> ( !fmt || 0 == strlen(fmt) ) {
<a name="l02006"></a>02006         error = EINVAL;
<a name="l02007"></a>02007         <span class="keywordflow">return</span> -1;
<a name="l02008"></a>02008     }
<a name="l02009"></a>02009     <span class="keywordflow">if</span> ( strlen(fmt) &gt; MAX_STRLEN || size &gt; MAX_STRLEN) {
<a name="l02010"></a>02010         error = EMSGSIZE;
<a name="l02011"></a>02011         <span class="keywordflow">return</span> -1;
<a name="l02012"></a>02012     }
<a name="l02013"></a>02013 
<a name="l02014"></a>02014     ind = 0;
<a name="l02015"></a>02015     <span class="keywordflow">for</span> ( i = 0; i &lt; strlen(fmt) &amp;&amp;
<a name="l02016"></a>02016                  (int)ind &lt; size - 1; ++i ) {
<a name="l02017"></a>02017         <span class="keywordflow">if</span> ( fmt[i] != <span class="charliteral">&apos;%&apos;</span> ) {
<a name="l02018"></a>02018             out[ind++] = fmt[i];
<a name="l02019"></a>02019             <span class="keywordflow">continue</span>;
<a name="l02020"></a>02020         }
<a name="l02021"></a>02021 
<a name="l02022"></a>02022         <span class="keywordflow">if</span> ( i == strlen(fmt) - 1 ) {
<a name="l02023"></a>02023             <span class="comment">// last character is %, invalid</span>
<a name="l02024"></a>02024             error = EINVAL;
<a name="l02025"></a>02025             <span class="keywordflow">return</span> ind;
<a name="l02026"></a>02026         }
<a name="l02027"></a>02027 
<a name="l02028"></a>02028         ch1 = fmt[i+1];
<a name="l02029"></a>02029 
<a name="l02030"></a>02030         <span class="keywordflow">if</span> ( ch1 == <span class="charliteral">&apos;%&apos;</span> ) {
<a name="l02031"></a>02031             out[ind++] = <span class="charliteral">&apos;%&apos;</span>;
<a name="l02032"></a>02032             ++i;
<a name="l02033"></a>02033             <span class="keywordflow">continue</span>;
<a name="l02034"></a>02034         }
<a name="l02035"></a>02035 
<a name="l02036"></a>02036         <span class="keywordflow">if</span> ( ch1 == <span class="charliteral">&apos;w&apos;</span> ) {
<a name="l02037"></a>02037             <span class="keywordflow">if</span> ( filename ) {
<a name="l02038"></a>02038                 strncpy( &amp;out[ind], filename, size - ind );
<a name="l02039"></a>02039                 ind += strlen(filename);
<a name="l02040"></a>02040             }
<a name="l02041"></a>02041             ++i;
<a name="l02042"></a>02042             <span class="keywordflow">continue</span>;
<a name="l02043"></a>02043         }
<a name="l02044"></a>02044 
<a name="l02045"></a>02045         <span class="keywordflow">if</span> ( ch1 == <span class="charliteral">&apos;f&apos;</span> ) {
<a name="l02046"></a>02046             <span class="keywordflow">if</span> ( eventname ) {
<a name="l02047"></a>02047                 strncpy( &amp;out[ind], eventname, size - ind );
<a name="l02048"></a>02048                 ind += strlen(eventname);
<a name="l02049"></a>02049             }
<a name="l02050"></a>02050             ++i;
<a name="l02051"></a>02051             <span class="keywordflow">continue</span>;
<a name="l02052"></a>02052         }
<a name="l02053"></a>02053 
<a name="l02054"></a>02054         <span class="keywordflow">if</span> ( ch1 == <span class="charliteral">&apos;e&apos;</span> ) {
<a name="l02055"></a>02055             eventstr = <a class="code" href="inotifytools_8h.html#a744bb8792d8ea8edbaf8f845fe1d9307">inotifytools_event_to_str</a>( event-&gt;mask );
<a name="l02056"></a>02056             strncpy( &amp;out[ind], eventstr, size - ind );
<a name="l02057"></a>02057             ind += strlen(eventstr);
<a name="l02058"></a>02058             ++i;
<a name="l02059"></a>02059             <span class="keywordflow">continue</span>;
<a name="l02060"></a>02060         }
<a name="l02061"></a>02061 
<a name="l02062"></a>02062         <span class="keywordflow">if</span> ( ch1 == <span class="charliteral">&apos;T&apos;</span> ) {
<a name="l02063"></a>02063 
<a name="l02064"></a>02064             <span class="keywordflow">if</span> ( timefmt ) {
<a name="l02065"></a>02065 
<a name="l02066"></a>02066                 now = time(0);
<a name="l02067"></a>02067                 <span class="keywordflow">if</span> ( 0 &gt;= strftime( timestr, MAX_STRLEN-1, timefmt,
<a name="l02068"></a>02068                                     localtime( &amp;now ) ) ) {
<a name="l02069"></a>02069 
<a name="l02070"></a>02070                     <span class="comment">// time format probably invalid</span>
<a name="l02071"></a>02071                     error = EINVAL;
<a name="l02072"></a>02072                     <span class="keywordflow">return</span> ind;
<a name="l02073"></a>02073                 }
<a name="l02074"></a>02074             }
<a name="l02075"></a>02075             <span class="keywordflow">else</span> {
<a name="l02076"></a>02076                 timestr[0] = 0;
<a name="l02077"></a>02077             }
<a name="l02078"></a>02078 
<a name="l02079"></a>02079             strncpy( &amp;out[ind], timestr, size - ind );
<a name="l02080"></a>02080             ind += strlen(timestr);
<a name="l02081"></a>02081             ++i;
<a name="l02082"></a>02082             <span class="keywordflow">continue</span>;
<a name="l02083"></a>02083         }
<a name="l02084"></a>02084 
<a name="l02085"></a>02085         <span class="comment">// Check if next char in fmt is e</span>
<a name="l02086"></a>02086         <span class="keywordflow">if</span> ( i &lt; strlen(fmt) - 2 &amp;&amp; fmt[i+2] == <span class="charliteral">&apos;e&apos;</span> ) {
<a name="l02087"></a>02087             eventstr = <a class="code" href="inotifytools_8h.html#a317a5b1ea969f570a49c4549b22e7e71">inotifytools_event_to_str_sep</a>( event-&gt;mask, ch1 );
<a name="l02088"></a>02088             strncpy( &amp;out[ind], eventstr, size - ind );
<a name="l02089"></a>02089             ind += strlen(eventstr);
<a name="l02090"></a>02090             i += 2;
<a name="l02091"></a>02091             <span class="keywordflow">continue</span>;
<a name="l02092"></a>02092         }
<a name="l02093"></a>02093 
<a name="l02094"></a>02094         <span class="comment">// OK, this wasn&apos;t a special format character, just output it as normal</span>
<a name="l02095"></a>02095         <span class="keywordflow">if</span> ( ind &lt; MAX_STRLEN ) out[ind++] = <span class="charliteral">&apos;%&apos;</span>;
<a name="l02096"></a>02096         <span class="keywordflow">if</span> ( ind &lt; MAX_STRLEN ) out[ind++] = ch1;
<a name="l02097"></a>02097         ++i;
<a name="l02098"></a>02098     }
<a name="l02099"></a>02099     out[ind] = 0;
<a name="l02100"></a>02100 
<a name="l02101"></a>02101     <span class="keywordflow">return</span> ind - 1;
<a name="l02102"></a>02102 }
<a name="l02103"></a>02103 
<a name="l02113"></a><a class="code" href="inotifytools_8h.html#af4528ccdf013b4c86e8f7fe4db88244a">02113</a> <span class="keywordtype">void</span> <a class="code" href="inotifytools_8h.html#af4528ccdf013b4c86e8f7fe4db88244a">inotifytools_set_printf_timefmt</a>( <span class="keywordtype">char</span> * fmt ) {
<a name="l02114"></a>02114     timefmt = fmt;
<a name="l02115"></a>02115 }
<a name="l02116"></a>02116 
<a name="l02125"></a><a class="code" href="inotifytools_8h.html#a1d96f4600d1187670304b83439b0cd05">02125</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a1d96f4600d1187670304b83439b0cd05">inotifytools_get_max_queued_events</a>() {
<a name="l02126"></a>02126     <span class="keywordtype">int</span> ret;
<a name="l02127"></a>02127     <span class="keywordflow">if</span> ( !read_num_from_file( QUEUE_SIZE_PATH, &amp;ret ) ) <span class="keywordflow">return</span> -1;
<a name="l02128"></a>02128     <span class="keywordflow">return</span> ret;
<a name="l02129"></a>02129 }
<a name="l02130"></a>02130 
<a name="l02140"></a><a class="code" href="inotifytools_8h.html#a9e8052a5fb77768cec9fff4aed9b9eb0">02140</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a9e8052a5fb77768cec9fff4aed9b9eb0">inotifytools_get_max_user_instances</a>() {
<a name="l02141"></a>02141     <span class="keywordtype">int</span> ret;
<a name="l02142"></a>02142     <span class="keywordflow">if</span> ( !read_num_from_file( INSTANCES_PATH, &amp;ret ) ) <span class="keywordflow">return</span> -1;
<a name="l02143"></a>02143     <span class="keywordflow">return</span> ret;
<a name="l02144"></a>02144 }
<a name="l02145"></a>02145 
<a name="l02155"></a><a class="code" href="inotifytools_8h.html#ae3b79f096737ef3c7e176324514b4556">02155</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#ae3b79f096737ef3c7e176324514b4556">inotifytools_get_max_user_watches</a>() {
<a name="l02156"></a>02156     <span class="keywordtype">int</span> ret;
<a name="l02157"></a>02157     <span class="keywordflow">if</span> ( !read_num_from_file( WATCHES_SIZE_PATH, &amp;ret ) ) <span class="keywordflow">return</span> -1;
<a name="l02158"></a>02158     <span class="keywordflow">return</span> ret;
<a name="l02159"></a>02159 }
<a name="l02160"></a>02160 
<a name="l02174"></a>02174 <span class="keyword">static</span> <span class="keywordtype">int</span> do_ignore_events_by_regex( <span class="keywordtype">char</span> <span class="keyword">const</span> *pattern, <span class="keywordtype">int</span> flags, <span class="keywordtype">int</span> invert ) {
<a name="l02175"></a>02175     <span class="keywordflow">if</span> (!pattern) {
<a name="l02176"></a>02176         <span class="keywordflow">if</span> (regex) {
<a name="l02177"></a>02177             regfree(regex);
<a name="l02178"></a>02178             free(regex);
<a name="l02179"></a>02179             regex = 0;
<a name="l02180"></a>02180         }
<a name="l02181"></a>02181         <span class="keywordflow">return</span> 1;
<a name="l02182"></a>02182     }
<a name="l02183"></a>02183 
<a name="l02184"></a>02184     <span class="keywordflow">if</span> (regex) { regfree(regex); }
<a name="l02185"></a>02185     <span class="keywordflow">else</span>       { regex = (regex_t *)malloc(<span class="keyword">sizeof</span>(regex_t)); }
<a name="l02186"></a>02186 
<a name="l02187"></a>02187     invert_regexp = invert;
<a name="l02188"></a>02188     <span class="keywordtype">int</span> ret = regcomp(regex, pattern, flags | REG_NOSUB);
<a name="l02189"></a>02189     <span class="keywordflow">if</span> (0 == ret) <span class="keywordflow">return</span> 1;
<a name="l02190"></a>02190 
<a name="l02191"></a>02191     regfree(regex);
<a name="l02192"></a>02192     free(regex);
<a name="l02193"></a>02193     regex = 0;
<a name="l02194"></a>02194     error = EINVAL;
<a name="l02195"></a>02195     <span class="keywordflow">return</span> 0;
<a name="l02196"></a>02196 }
<a name="l02197"></a>02197 
<a name="l02209"></a><a class="code" href="inotifytools_8h.html#a07f4f258123feb8864f89663a2785ef0">02209</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a07f4f258123feb8864f89663a2785ef0">inotifytools_ignore_events_by_regex</a>( <span class="keywordtype">char</span> <span class="keyword">const</span> *pattern, <span class="keywordtype">int</span> flags ) {
<a name="l02210"></a>02210     <span class="keywordflow">return</span> do_ignore_events_by_regex(pattern, flags, 0);
<a name="l02211"></a>02211 }
<a name="l02212"></a>02212 
<a name="l02224"></a><a class="code" href="inotifytools_8h.html#a6f246b367da63c839aab6546319d196c">02224</a> <span class="keywordtype">int</span> <a class="code" href="inotifytools_8h.html#a6f246b367da63c839aab6546319d196c">inotifytools_ignore_events_by_inverted_regex</a>( <span class="keywordtype">char</span> <span class="keyword">const</span> *pattern, <span class="keywordtype">int</span> flags ) {
<a name="l02225"></a>02225     <span class="keywordflow">return</span> do_ignore_events_by_regex(pattern, flags, 1);
<a name="l02226"></a>02226 }
<a name="l02227"></a>02227 
<a name="l02228"></a>02228 <span class="keywordtype">int</span> event_compare(<span class="keyword">const</span> <span class="keywordtype">void</span> *p1, <span class="keyword">const</span> <span class="keywordtype">void</span> *p2, <span class="keyword">const</span> <span class="keywordtype">void</span> *config)
<a name="l02229"></a>02229 {
<a name="l02230"></a>02230     <span class="keywordflow">if</span> (!p1 || !p2) <span class="keywordflow">return</span> p1 - p2;
<a name="l02231"></a>02231     <span class="keywordtype">char</span> asc = 1;
<a name="l02232"></a>02232     <span class="keywordtype">int</span> sort_event = (int)config;
<a name="l02233"></a>02233     <span class="keywordflow">if</span> (sort_event == -1) {
<a name="l02234"></a>02234         sort_event = 0;
<a name="l02235"></a>02235         asc = 0;
<a name="l02236"></a>02236     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sort_event &lt; 0) {
<a name="l02237"></a>02237         sort_event = -sort_event;
<a name="l02238"></a>02238         asc = 0;
<a name="l02239"></a>02239     }
<a name="l02240"></a>02240     <span class="keywordtype">int</span> *i1 = stat_ptr((watch*)p1, sort_event);
<a name="l02241"></a>02241     <span class="keywordtype">int</span> *i2 = stat_ptr((watch*)p2, sort_event);
<a name="l02242"></a>02242     <span class="keywordflow">if</span> (0 == *i1 - *i2) {
<a name="l02243"></a>02243         <span class="keywordflow">return</span> ((watch*)p1)-&gt;wd - ((watch*)p2)-&gt;wd;
<a name="l02244"></a>02244     }
<a name="l02245"></a>02245     <span class="keywordflow">if</span> (asc)
<a name="l02246"></a>02246         <span class="keywordflow">return</span> *i1 - *i2;
<a name="l02247"></a>02247     <span class="keywordflow">else</span>
<a name="l02248"></a>02248         <span class="keywordflow">return</span> *i2 - *i1;
<a name="l02249"></a>02249 }
<a name="l02250"></a>02250 
<a name="l02251"></a>02251 <span class="keyword">struct </span>rbtree *inotifytools_wd_sorted_by_event(<span class="keywordtype">int</span> sort_event)
<a name="l02252"></a>02252 {
<a name="l02253"></a>02253     <span class="keyword">struct </span>rbtree *ret = rbinit(event_compare, (<span class="keywordtype">void</span>*)sort_event);
<a name="l02254"></a>02254     RBLIST *all = rbopenlist(tree_wd);
<a name="l02255"></a>02255     <span class="keywordtype">void</span> <span class="keyword">const</span> *p = rbreadlist(all);
<a name="l02256"></a>02256     <span class="keywordflow">while</span> (p) {
<a name="l02257"></a>02257         <span class="keywordtype">void</span> <span class="keyword">const</span> *r = rbsearch(p, ret);
<a name="l02258"></a>02258         niceassert((<span class="keywordtype">int</span>)(r == p), <span class="stringliteral">&quot;Couldn&apos;t insert watch into new tree&quot;</span>);
<a name="l02259"></a>02259         p = rbreadlist(all);
<a name="l02260"></a>02260     }
<a name="l02261"></a>02261     rbcloselist(all);
<a name="l02262"></a>02262     <span class="keywordflow">return</span> ret;
<a name="l02263"></a>02263 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 24 Oct 2018 for libinotifytools by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
